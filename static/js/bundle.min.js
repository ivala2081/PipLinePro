let currentScreenSize='desktop';let sidebarVisible=true;let chartsInitialized=false;function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}function throttle(func,limit){let inThrottle;return function(){const args=arguments;const context=this;if(!inThrottle){func.apply(context,args);inThrottle=true;setTimeout(()=> inThrottle=false,limit);}}}function getScreenSize(){const width=window.innerWidth;if(width < 576)return 'xs';if(width < 768)return 'sm';if(width < 992)return 'md';if(width < 1200)return 'lg';return 'xl';}function updateLayoutForScreenSize(screenSize){const sidebar=document.querySelector('.sidebar');const mainContent=document.querySelector('.main-content');if(!sidebar || !mainContent)return;switch(screenSize){case 'xs':case 'sm':sidebar.classList.remove('show');mainContent.style.marginLeft='0';mainContent.style.width='100%';break;case 'md':case 'lg':case 'xl':sidebar.classList.add('show');mainContent.style.marginLeft='250px';mainContent.style.width='calc(100% - 250px)';break;}}function updateScreenSize(){const newSize=getScreenSize();if(newSize !==currentScreenSize){currentScreenSize=newSize;document.dispatchEvent(new CustomEvent('screenSizeChanged',{detail:{size: newSize}}));updateLayoutForScreenSize(newSize);}}function fixSidebarNavigationLayout(){const sidebarNav=document.querySelector('.sidebar-nav');const navLinks=document.querySelectorAll('.sidebar-nav .nav-link');if(!sidebarNav)return;console.log('üîß Fixing sidebar navigation layout...');console.log('Found navigation items:',navLinks.length);navLinks.forEach((link,index)=>{link.style.position='relative';link.style.float='none';link.style.clear='both';link.style.width='100%';link.style.display='flex';link.style.flexDirection='row';link.style.alignItems='center';link.style.marginBottom='0.5rem';link.style.minHeight='44px';link.style.boxSizing='border-box';if(index < navLinks.length - 1){link.style.marginBottom='0.5rem';}else{link.style.marginBottom='0';}console.log(`Nav link ${index + 1}:`,link.textContent.trim(),'- Position:',link.style.position,'- Display:',link.style.display);});sidebarNav.style.display='flex';sidebarNav.style.flexDirection='column';sidebarNav.style.width='100%';sidebarNav.style.alignItems='stretch';sidebarNav.style.gap='0.25rem';console.log('‚úÖ Sidebar navigation layout fixed');}function ensureVerticalStacking(){const sidebarContent=document.querySelector('.sidebar-content');const sidebarNav=document.querySelector('.sidebar-nav');if(sidebarContent && sidebarNav){sidebarContent.style.display='flex';sidebarContent.style.flexDirection='column';sidebarContent.style.width='100%';sidebarContent.style.alignItems='stretch';sidebarNav.style.display='flex';sidebarNav.style.flexDirection='column';sidebarNav.style.width='100%';sidebarNav.style.alignItems='stretch';const navLinks=document.querySelectorAll('.sidebar-nav .nav-link');navLinks.forEach((link,index)=>{const rect=link.getBoundingClientRect();const nextLink=navLinks[index + 1];if(nextLink){const nextRect=nextLink.getBoundingClientRect();if(rect.bottom > nextRect.top){console.warn(`‚ö†Ô∏è Overlapping detected between items ${index + 1} and ${index + 2}`);link.style.marginBottom='0.5rem';nextLink.style.marginTop='0';}}});console.log('üîç Vertical stacking verification complete');}}class ResponsiveManager{constructor(){this.currentBreakpoint=null;this.isMobile=false;this.isTablet=false;this.isDesktop=false;this.resizeTimeout=null;this.init();}init(){this.detectScreenSize();this.setupEventListeners();this.fixGridLayouts();this.fixSidebarBehavior();this.fixContentOverflow();this.setupTouchSupport();this.fixTableResponsiveness();this.fixFormResponsiveness();this.fixModalResponsiveness();this.fixNavigationResponsiveness();}detectScreenSize(){const width=window.innerWidth;if(width <=576){this.currentBreakpoint='xs';this.isMobile=true;}else if(width <=768){this.currentBreakpoint='sm';this.isMobile=true;}else if(width <=992){this.currentBreakpoint='md';this.isTablet=true;}else if(width <=1200){this.currentBreakpoint='lg';this.isDesktop=true;}else{this.currentBreakpoint='xl';this.isDesktop=true;}document.documentElement.setAttribute('data-breakpoint',this.currentBreakpoint);this.updateResponsiveClasses();}updateResponsiveClasses(){const body=document.body;body.classList.remove('breakpoint-xs','breakpoint-sm','breakpoint-md','breakpoint-lg','breakpoint-xl');body.classList.add(`breakpoint-${this.currentBreakpoint}`);body.classList.remove('is-mobile','is-tablet','is-desktop');if(this.isMobile)body.classList.add('is-mobile');if(this.isTablet)body.classList.add('is-tablet');if(this.isDesktop)body.classList.add('is-desktop');}setupEventListeners(){window.addEventListener('resize',()=>{clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(()=>{this.detectScreenSize();this.fixGridLayouts();this.fixSidebarBehavior();this.fixContentOverflow();this.fixTableResponsiveness();this.fixFormResponsiveness();},250);});window.addEventListener('orientationchange',()=>{setTimeout(()=>{this.detectScreenSize();this.fixGridLayouts();this.fixSidebarBehavior();this.fixContentOverflow();},500);});}fixGridLayouts(){const metricsGrid=document.querySelector('.metrics-grid');if(metricsGrid){this.forceGridLayout(metricsGrid);}const contentGrid=document.querySelector('.dashboard-content-grid');if(contentGrid){this.forceGridLayout(contentGrid);}const actionsGrid=document.querySelector('.quick-actions-grid');if(actionsGrid){this.forceGridLayout(actionsGrid);}}forceGridLayout(element){if(!element)return;const width=window.innerWidth;let columns=4;if(width < 576)columns=1;else if(width < 768)columns=2;else if(width < 992)columns=3;else if(width < 1200)columns=4;else columns=4;element.style.display='grid';element.style.gridTemplateColumns=`repeat(${columns},1fr)`;element.style.gap='1rem';element.style.width='100%';}fixSidebarBehavior(){const sidebar=document.querySelector('.sidebar');const mainContent=document.querySelector('.main-content');if(!sidebar || !mainContent)return;if(this.isMobile || this.isTablet){sidebar.classList.remove('show');mainContent.style.marginLeft='0';mainContent.style.width='100%';}else{sidebar.classList.add('show');mainContent.style.marginLeft='250px';mainContent.style.width='calc(100% - 250px)';}}fixContentOverflow(){const containers=document.querySelectorAll('.content-container,.card-body,.table-responsive');containers.forEach(container=>{container.style.overflowX='auto';container.style.overflowY='visible';});}setupTouchSupport(){const touchElements=document.querySelectorAll('.btn,.nav-link,.card');touchElements.forEach(element=>{element.style.minHeight='44px';element.style.minWidth='44px';});}fixTableResponsiveness(){const tables=document.querySelectorAll('.table-responsive');tables.forEach(tableContainer=>{const table=tableContainer.querySelector('table');if(!table)return;this.setupTableScroll(tableContainer);this.setupTableTouch(tableContainer);if(this.isMobile){this.optimizeTableForMobile(tableContainer);}});}setupTableScroll(container){if(!container)return;const scrollLeft=document.createElement('div');scrollLeft.className='scroll-indicator scroll-left';scrollLeft.innerHTML='<i class="bi bi-chevron-left"></i>';const scrollRight=document.createElement('div');scrollRight.className='scroll-indicator scroll-right';scrollRight.innerHTML='<i class="bi bi-chevron-right"></i>';container.appendChild(scrollLeft);container.appendChild(scrollRight);container.addEventListener('scroll',()=>{this.updateScrollIndicators(container);});this.updateScrollIndicators(container);}updateScrollIndicators(container){const scrollLeft=container.querySelector('.scroll-left');const scrollRight=container.querySelector('.scroll-right');if(scrollLeft && scrollRight){scrollLeft.style.display=container.scrollLeft > 0 ? 'block' : 'none';scrollRight.style.display=container.scrollLeft <(container.scrollWidth - container.clientWidth)? 'block' : 'none';}}setupTableTouch(container){let startX=0;let scrollLeft=0;container.addEventListener('touchstart',(e)=>{startX=e.touches[0].pageX - container.offsetLeft;scrollLeft=container.scrollLeft;});container.addEventListener('touchmove',(e)=>{if(!startX)return;const x=e.touches[0].pageX - container.offsetLeft;const walk=(x - startX)* 2;container.scrollLeft=scrollLeft - walk;});container.addEventListener('touchend',()=>{startX=0;});}optimizeTableForMobile(container){const table=container.querySelector('table');if(!table)return;table.style.fontSize='14px';table.style.minWidth='600px';container.style.overflowX='auto';container.style.overflowY='hidden';}fixFormResponsiveness(){const forms=document.querySelectorAll('form');forms.forEach(form=>{if(this.isMobile){this.optimizeFormForMobile(form);}this.setupFormValidation(form);});}optimizeFormForMobile(form){const inputs=form.querySelectorAll('input,select,textarea');inputs.forEach(input=>{input.style.fontSize='16px';input.style.minHeight='44px';});}setupFormValidation(form){const inputs=form.querySelectorAll('input,select,textarea');inputs.forEach(input=>{input.addEventListener('blur',()=> this.validateField(input));input.addEventListener('input',()=> this.clearFieldError(input));});}validateField(field){const value=field.value.trim();const required=field.hasAttribute('required');const pattern=field.getAttribute('pattern');if(required && !value){this.showFieldError(field,'This field is required');return false;}if(pattern && value){const regex=new RegExp(pattern);if(!regex.test(value)){this.showFieldError(field,'Invalid format');return false;}}this.clearFieldError(field);return true;}showFieldError(field,message){this.clearFieldError(field);const errorDiv=document.createElement('div');errorDiv.className='field-error';errorDiv.textContent=message;errorDiv.style.color='#dc3545';errorDiv.style.fontSize='12px';errorDiv.style.marginTop='4px';field.parentNode.appendChild(errorDiv);field.classList.add('is-invalid');}clearFieldError(field){const errorDiv=field.parentNode.querySelector('.field-error');if(errorDiv){errorDiv.remove();}field.classList.remove('is-invalid');}fixModalResponsiveness(){const modals=document.querySelectorAll('.modal');modals.forEach(modal=>{if(this.isMobile){modal.style.margin='10px';modal.style.maxWidth='calc(100% - 20px)';}});}fixNavigationResponsiveness(){const navTabs=document.querySelectorAll('.nav-tabs');navTabs.forEach(container=>{if(this.isMobile){this.setupTabScroll(container);}});}setupTabScroll(container){container.style.overflowX='auto';container.style.overflowY='hidden';container.style.whiteSpace='nowrap';container.style.display='flex';container.style.flexWrap='nowrap';const tabs=container.querySelectorAll('.nav-link');tabs.forEach(tab=>{tab.style.flexShrink='0';tab.style.whiteSpace='nowrap';});}}class SidebarManager{constructor(){this.init();}init(){this.setupMobileBehavior();this.setupKeyboardSupport();this.setupTouchSupport();this.ensureAllNavItemsVisible();this.fixNavigationLayout();}setupMobileBehavior(){const sidebar=document.querySelector('.sidebar');const toggleBtn=document.querySelector('.sidebar-toggle');const overlay=document.querySelector('.sidebar-overlay');if(toggleBtn){toggleBtn.addEventListener('click',()=> this.toggleSidebar());}if(overlay){overlay.addEventListener('click',()=> this.hideSidebar());}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){this.hideSidebar();}});}setupKeyboardSupport(){const sidebar=document.querySelector('.sidebar');if(sidebar){sidebar.setAttribute('tabindex','0');}}setupTouchSupport(){const sidebar=document.querySelector('.sidebar');if(!sidebar)return;let startX=0;let currentX=0;let isDragging=false;sidebar.addEventListener('touchstart',(e)=>{startX=e.touches[0].clientX;isDragging=true;});sidebar.addEventListener('touchmove',(e)=>{if(!isDragging)return;currentX=e.touches[0].clientX;const diff=startX - currentX;if(diff > 50){this.hideSidebar();isDragging=false;}});sidebar.addEventListener('touchend',()=>{isDragging=false;});}toggleSidebar(){const sidebar=document.querySelector('.sidebar');if(sidebar.classList.contains('show')){this.hideSidebar();}else{this.showSidebar();}}showSidebar(){const sidebar=document.querySelector('.sidebar');const overlay=document.querySelector('.sidebar-overlay');if(sidebar){sidebar.classList.add('show');}if(overlay){overlay.style.display='block';}}hideSidebar(){const sidebar=document.querySelector('.sidebar');const overlay=document.querySelector('.sidebar-overlay');if(sidebar){sidebar.classList.remove('show');}if(overlay){overlay.style.display='none';}}ensureAllNavItemsVisible(){const navLinks=document.querySelectorAll('.sidebar-nav .nav-link');navLinks.forEach(link=>{link.style.display='flex';link.style.visibility='visible';link.style.opacity='1';});}fixNavigationLayout(){console.log('üîß SidebarManager: Fixing navigation layout...');fixSidebarNavigationLayout();ensureVerticalStacking();setTimeout(()=>{fixSidebarNavigationLayout();ensureVerticalStacking();},100);}}class PSPAllocationManager{constructor(){this.allocations=new Map();this.isSaving=false;this.debounceTimer=null;this.init();}init(){this.setupAllocationInputs();this.setupSaveButton();this.setupValidation();this.setupRealTimeUpdates();this.setupKeyboardShortcuts();}setupAllocationInputs(){const allocationInputs=document.querySelectorAll('.allocation-input input');allocationInputs.forEach((input,index)=>{input.classList.add('allocation-input-enhanced');input.addEventListener('input',(e)=> this.handleAllocationInput(e));input.addEventListener('blur',(e)=> this.handleAllocationBlur(e));input.addEventListener('focus',(e)=> this.handleAllocationFocus(e));input.addEventListener('keydown',(e)=> this.handleAllocationKeydown(e));this.addInputIndicators(input);this.updateAllocation(input);});}addInputIndicators(input){const container=input.closest('.allocation-input');if(!container)return;const statusIndicator=document.createElement('div');statusIndicator.className='allocation-status';statusIndicator.innerHTML=` <div class="status-dot"></div> <span class="status-text">Ready</span> `;container.appendChild(statusIndicator);const validationIndicator=document.createElement('div');validationIndicator.className='allocation-validation';validationIndicator.innerHTML=` <i class="bi bi-check-circle-fill text-success"></i> `;container.appendChild(validationIndicator);}handleAllocationInput(event){const input=event.target;const value=parseFloat(input.value)|| 0;const netAmount=parseFloat(input.dataset.net)|| 0;this.updateAllocation(input);const validation=this.validateAllocation(value,netAmount);this.updateInputValidation(input,validation);this.debounceSave();this.updateRealTimeCalculations();}handleAllocationBlur(event){const input=event.target;const value=parseFloat(input.value)|| 0;if(value > 0){this.saveAllocation(input);}}handleAllocationFocus(event){const input=event.target;this.updateInputStatus(input,'editing');}handleAllocationKeydown(event){if(event.key==='Enter'){event.preventDefault();this.moveToNextInput(event.target);}else if(event.key==='Escape'){this.cancelAllocation(event.target);}}validateAllocation(value,netAmount){if(value < 0)return{valid: false,message: 'Value cannot be negative'};if(value > netAmount)return{valid: false,message: 'Value cannot exceed net amount'};return{valid: true,message: 'Valid allocation'};}updateInputValidation(input,validation){const container=input.closest('.allocation-input');if(!container)return;const validationIndicator=container.querySelector('.allocation-validation');if(validationIndicator){validationIndicator.innerHTML=validation.valid ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>';}}updateInputStatus(input,status){const container=input.closest('.allocation-input');if(!container)return;const statusIndicator=container.querySelector('.allocation-status');if(statusIndicator){const statusText=statusIndicator.querySelector('.status-text');const statusDot=statusIndicator.querySelector('.status-dot');if(statusText)statusText.textContent=status;if(statusDot){statusDot.className=`status-dot status-${status}`;}}}updateAllocation(input){const value=parseFloat(input.value)|| 0;const date=input.dataset.date;const psp=input.dataset.psp;if(date && psp){this.allocations.set(`${date}-${psp}`,value);}}debounceSave(){clearTimeout(this.debounceTimer);this.debounceTimer=setTimeout(()=>{this.saveAllAllocations();},1000);}async saveAllocation(input){const value=parseFloat(input.value)|| 0;const date=input.dataset.date;const psp=input.dataset.psp;if(!date || !psp)return;try{this.updateInputStatus(input,'saving');const response=await fetch('/api/psp-allocation',{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({date,psp,value})});if(response.ok){this.updateInputStatus(input,'saved');this.showSuccess('Allocation saved successfully');}else{throw new Error('Failed to save allocation');}}catch(error){this.updateInputStatus(input,'error');this.showError('Failed to save allocation');}}async saveAllAllocations(){if(this.isSaving)return;this.isSaving=true;this.updateSaveButton('Saving...',true);try{const allocationsData=Array.from(this.allocations.entries()).map(([key,value])=>{const [date,psp]=key.split('-');return{date,psp,value};});const response=await fetch('/api/psp-allocations',{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({allocations: allocationsData})});if(response.ok){this.showSuccess('All allocations saved successfully');this.allocations.clear();}else{throw new Error('Failed to save allocations');}}catch(error){this.showError('Failed to save allocations');}finally{this.isSaving=false;this.updateSaveButton('Save All',false);}}setupSaveButton(){const saveBtn=document.querySelector('.save-allocations-btn');if(saveBtn){saveBtn.addEventListener('click',()=> this.saveAllAllocations());}}updateSaveButton(text,disabled){const saveBtn=document.querySelector('.save-allocations-btn');if(saveBtn){saveBtn.textContent=text;saveBtn.disabled=disabled;}}setupRealTimeUpdates(){this.updateRealTimeCalculations();}updateRealTimeCalculations(){let total=0;this.allocations.forEach(value=>{total +=value;});this.updateTotalAllocation(total);}updateTotalAllocation(total){const totalElement=document.querySelector('.total-allocation');if(totalElement){totalElement.textContent=formatCurrency(total);}}moveToNextInput(currentInput){const inputs=Array.from(document.querySelectorAll('.allocation-input input'));const currentIndex=inputs.indexOf(currentInput);const nextInput=inputs[currentIndex + 1];if(nextInput){nextInput.focus();}}cancelAllocation(input){input.value='';this.updateAllocation(input);this.updateInputStatus(input,'ready');}getCSRFToken(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')|| document.querySelector('input[name="csrf_token"]')?.value || '';}setupKeyboardShortcuts(){document.addEventListener('keydown',(e)=>{if(e.ctrlKey && e.key==='s'){e.preventDefault();this.saveAllAllocations();}});}setupValidation(){}showSuccess(message){showNotification(message,'success');}showError(message){showNotification(message,'error');}}function initCharts(){if(chartsInitialized)return;const chartContainers=document.querySelectorAll('[data-chart]');chartContainers.forEach(container=>{const chartType=container.dataset.chart;initializeChart(container,chartType);});chartsInitialized=true;}function initializeChart(container,type){if(!container)return;try{switch(type){case 'line': initLineChart(container);break;case 'bar': initBarChart(container);break;case 'pie': initPieChart(container);break;case 'area': initAreaChart(container);break;default: showChartError(container);}}catch(error){console.error('Chart initialization error:',error);showChartError(container);}}function initLineChart(container){console.log('Initializing line chart');}function initBarChart(container){console.log('Initializing bar chart');}function initPieChart(container){console.log('Initializing pie chart');}function initAreaChart(container){console.log('Initializing area chart');}function showChartError(container){if(container){container.innerHTML='<div class="chart-error">Chart could not be loaded</div>';}}function showNotification(message,type='info',duration=5000){const notification=document.createElement('div');notification.className=`alert alert-${type}alert-dismissible fade show position-fixed`;notification.style.cssText=` top: 20px;right: 20px;z-index: 9999;min-width: 300px;box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;notification.innerHTML=` ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button> `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove();}},duration);}function showSuccess(message,duration=3000){showNotification(message,'success',duration);}function showError(message,duration=5000){showNotification(message,'danger',duration);}function showWarning(message,duration=4000){showNotification(message,'warning',duration);}function showLoading(message='Loading...'){const loading=document.createElement('div');loading.id='loading-overlay';loading.innerHTML=` <div class="loading-spinner"> <div class="spinner-border text-primary" role="status"> <span class="visually-hidden">Loading...</span> </div> <div class="loading-message">${message}</div> </div> `;loading.style.cssText=` position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,0.5);display: flex;align-items: center;justify-content: center;z-index: 9999;`;document.body.appendChild(loading);}function hideLoading(){const loading=document.getElementById('loading-overlay');if(loading){loading.remove();}}function formatNumber(num){return new Intl.NumberFormat('tr-TR').format(num);}function formatCurrency(amount,currency='TL'){return new Intl.NumberFormat('tr-TR',{style: 'currency',currency: currency}).format(amount);}function formatDate(date){return new Intl.DateTimeFormat('tr-TR').format(new Date(date));}function getUrlParameter(name){const urlParams=new URLSearchParams(window.location.search);return urlParams.get(name);}function setUrlParameter(name,value){const url=new URL(window.location);url.searchParams.set(name,value);window.history.replaceState({},'',url);}document.addEventListener('DOMContentLoaded',function(){window.responsiveManager=new ResponsiveManager();window.sidebarManager=new SidebarManager();if(document.querySelector('.allocation-input')){window.pspAllocationManager=new PSPAllocationManager();}initCharts();updateScreenSize();window.addEventListener('resize',debounce(updateScreenSize,250));fixSidebarNavigationLayout();ensureVerticalStacking();setTimeout(()=>{fixSidebarNavigationLayout();ensureVerticalStacking();},500);console.log('üöÄ PipLine JavaScript Bundle Loaded Successfully');});window.PipLine={showNotification,showSuccess,showError,showWarning,showLoading,hideLoading,formatNumber,formatCurrency,formatDate,getUrlParameter,setUrlParameter,fixSidebarNavigationLayout,ensureVerticalStacking}; 