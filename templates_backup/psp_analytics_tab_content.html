{% block content %}
<div id="psp-analytics-tab-content">
  <div class="row g-4">
    <!-- PSP Overview Cards -->
    <div class="col-12">
      <div class="row g-3">
        <div class="col-lg-3 col-md-6">
          <div class="card business-card-clean border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="analytics-icon bg-primary bg-opacity-10 rounded-circle p-3">
                  <i class="bi bi-shield-check text-primary fs-4"></i>
                </div>
              </div>
              <h3 class="fw-bold text-primary mb-1">{{ summary_data|length }}</h3>
              <p class="text-muted mb-0">{{ _('Active PSPs') }}</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="card business-card-clean border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="analytics-icon bg-success bg-opacity-10 rounded-circle p-3">
                  <i class="bi bi-currency-dollar text-success fs-4"></i>
                </div>
              </div>
              <h3 class="fw-bold text-success mb-1">
                {% set total_volume = 0 %}
                {% for date_summary in summary_data %}
                  {% for psp, psp_data in date_summary.psps.items() %}
                    {% set total_volume = total_volume + psp_data['toplam']|float %}
                  {% endfor %}
                {% endfor %}
                {{ total_volume|format_number }}
              </h3>
              <p class="text-muted mb-0">{{ _('Total Volume') }}</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="card business-card-clean border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="analytics-icon bg-warning bg-opacity-10 rounded-circle p-3">
                  <i class="bi bi-percent text-warning fs-4"></i>
                </div>
              </div>
              <h3 class="fw-bold text-warning mb-1">
                {% set total_commission = 0 %}
                {% for date_summary in summary_data %}
                  {% for psp, psp_data in date_summary.psps.items() %}
                    {% set total_commission = total_commission + psp_data['komisyon']|float %}
                  {% endfor %}
                {% endfor %}
                {{ total_commission|format_number }}
              </h3>
              <p class="text-muted mb-0">{{ _('Total Commission') }}</p>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="card business-card-clean border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="analytics-icon bg-info bg-opacity-10 rounded-circle p-3">
                  <i class="bi bi-check-circle text-info fs-4"></i>
                </div>
              </div>
              <h3 class="fw-bold text-info mb-1">
                {% set paid_count = 0 %}
                {% set total_count = 0 %}
                {% for date_summary in summary_data %}
                  {% for psp, psp_data in date_summary.psps.items() %}
                    {% set total_count = total_count + 1 %}
                    {% if psp_data['paid'] %}
                      {% set paid_count = paid_count + 1 %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
                {{ paid_count }}/{{ total_count }}
              </h3>
              <p class="text-muted mb-0">{{ _('Paid Transactions') }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="col-12">
      <div class="row g-4">
        <!-- PSP Performance Chart -->
        <div class="col-lg-8">
          <div class="card business-card-clean border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pb-0">
              <h5 class="card-title mb-0">
                <i class="bi bi-bar-chart-line text-primary me-2"></i>
                {{ _('PSP Performance Over Time') }}
              </h5>
            </div>
            <div class="card-body">
              <canvas id="pspPerformanceChart" height="100"></canvas>
            </div>
          </div>
        </div>

        <!-- PSP Distribution Chart -->
        <div class="col-lg-4">
          <div class="card business-card-clean border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pb-0">
              <h5 class="card-title mb-0">
                <i class="bi bi-pie-chart text-success me-2"></i>
                {{ _('PSP Volume Distribution') }}
              </h5>
            </div>
            <div class="card-body">
              <canvas id="pspDistributionChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PSP Details Table -->
    <div class="col-12">
      <div class="card business-card-clean border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="card-title mb-0">
                <i class="bi bi-table text-info me-2"></i>
                {{ _('PSP Performance Summary') }}
              </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive-clean">
            <table class="table table-clean table-hover">
              <thead class="enhanced-table-header-clean">
                <tr>
                  <th>{{ _('PSP') }}</th>
                  <th class="text-end">{{ _('Total Volume') }}</th>
                  <th class="text-end">{{ _('Total Commission') }}</th>
                  <th class="text-end">{{ _('Net Amount') }}</th>
                  <th class="text-center">{{ _('Paid Rate') }}</th>
                  <th class="text-center">{{ _('Status') }}</th>
                </tr>
              </thead>
              <tbody>
                {% set psp_stats = {} %}
                {% for date_summary in summary_data %}
                  {% for psp, psp_data in date_summary.psps.items() %}
                    {% if psp not in psp_stats %}
                      {% set _ = psp_stats.update({psp: {'volume': 0, 'commission': 0, 'net': 0, 'paid': 0, 'total': 0}}) %}
                    {% endif %}
                    {% set _ = psp_stats.update({psp: {
                      'volume': psp_stats[psp]['volume'] + psp_data['toplam']|float,
                      'commission': psp_stats[psp]['commission'] + psp_data['komisyon']|float,
                      'net': psp_stats[psp]['net'] + psp_data['net']|float,
                      'paid': psp_stats[psp]['paid'] + (1 if psp_data['paid'] else 0),
                      'total': psp_stats[psp]['total'] + 1
                    }}) %}
                  {% endfor %}
                {% endfor %}
                
                {% for psp, stats in psp_stats.items() %}
                <tr>
                  <td class="fw-semibold">{{ psp }}</td>
                  <td class="text-end fw-bold text-primary">{{ stats.volume|format_number }}</td>
                  <td class="text-end fw-bold text-warning">{{ stats.commission|format_number }}</td>
                  <td class="text-end fw-bold {% if stats.net >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ stats.net|format_number }}
                  </td>
                  <td class="text-center">
                    {% set paid = stats.paid|safe_float %}
                    {% set total = stats.total|safe_float %}
                    {% set paid_rate = (paid / total * 100) if total > 0 else 0 %}
                    <span class="badge-clean {% if paid_rate >= 80 %}bg-success{% elif paid_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                      {{ "{:.1f}".format(paid_rate) }}%
                    </span>
                  </td>
                  <td class="text-center">
                    {% if paid_rate >= 80 %}
                      <span class="badge-clean bg-success"><i class="bi bi-check-circle"></i> {{ _('Excellent') }}</span>
                    {% elif paid_rate >= 60 %}
                      <span class="badge-clean bg-warning"><i class="bi bi-exclamation-triangle"></i> {{ _('Good') }}</span>
                    {% else %}
                      <span class="badge-clean bg-danger"><i class="bi bi-x-circle"></i> {{ _('Needs Attention') }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
// Initialize PSP Analytics Charts
document.addEventListener('DOMContentLoaded', function() {
  // Initialize charts when the analytics tab is shown
  const analyticsTab = document.getElementById('analytics-tab');
  if (analyticsTab) {
    analyticsTab.addEventListener('shown.bs.tab', function() {
      setTimeout(() => {
        initPSPAnalyticsCharts();
      }, 100);
    });
  }
  
  // Initialize charts if already on analytics tab
  const analyticsTabPane = document.getElementById('analytics');
  if (analyticsTabPane && analyticsTabPane.classList.contains('show')) {
    setTimeout(() => {
      initPSPAnalyticsCharts();
    }, 100);
  }
});

function initPSPAnalyticsCharts() {
  // PSP Performance Chart
  const performanceCtx = document.getElementById('pspPerformanceChart');
  if (performanceCtx && typeof Chart !== 'undefined') {
    new Chart(performanceCtx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: '{{ _("PSP Performance") }}',
          data: [12, 19, 3, 5, 2, 3],
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
  
  // PSP Distribution Chart
  const distributionCtx = document.getElementById('pspDistributionChart');
  if (distributionCtx && typeof Chart !== 'undefined') {
    new Chart(distributionCtx, {
      type: 'doughnut',
      data: {
        labels: ['PSP 1', 'PSP 2', 'PSP 3', 'PSP 4'],
        datasets: [{
          data: [30, 25, 25, 20],
          backgroundColor: [
            '#007bff',
            '#28a745',
            '#ffc107',
            '#dc3545'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
}
</script>
{% endblock %} 