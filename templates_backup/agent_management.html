{% extends "base.html" %}

{% block title %}Agent Management - PipLine{% endblock %}

{% block content %}
<div class="page-container">
  <!-- Enhanced Header -->
  <div class="page-header">
    <div class="d-flex">
      <div>
        <h1 class="h2 mb-1 text-dark fw-bold">
          <i class="bi bi-people-fill text-primary me-2"></i>
          Agent Management
        </h1>
        <p class="text-muted mb-0 small">
          Salary, bonuses and commission calculations for agents across departments
        </p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="status-indicator">
          <span class="status-dot bg-success"></span>
          <span class="status-text small text-muted">Live</span>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('analytics.add_employee') }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Employee
          </a>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeDateRange(7)">7 Days</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeDateRange(30)">30 Days</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeDateRange(90)">90 Days</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Streamlined Metrics -->
  <div class="metrics-row mb-4">
    <div class="row g-3">
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-primary bg-opacity-10">
            <i class="bi bi-people text-primary"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ stats.total_agents }}</div>
            <div class="metric-label">Total Agents</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-success bg-opacity-10">
            <i class="bi bi-currency-dollar text-success"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">₺{{ "{:,.0f}".format(stats.total_final_salary) }}</div>
            <div class="metric-label">Total Final Salary</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-info bg-opacity-10">
            <i class="bi bi-currency-exchange text-info"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">${{ "{:,.0f}".format(stats.total_usd_salary) }}</div>
            <div class="metric-label">Total USD Salary</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-warning bg-opacity-10">
            <i class="bi bi-person-check text-warning"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ stats.active_agents }}</div>
            <div class="metric-label">Active Agents</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Tab Navigation -->
  <div class="tab-container">
    <ul class="nav nav-tabs border-0" id="agentsTab" role="tablist">
      {% for dept in available_departments %}
      <li class="nav-item" role="presentation">
        <a class="nav-link {% if selected_department == dept or (dept == 'overview' and not selected_department) %}active{% endif %} border-0"
           href="{{ url_for('analytics.agent_management', department=dept) }}"
           role="tab">
          {% if dept == 'overview' %}
            <i class="bi bi-grid-3x3-gap me-2"></i> Overview
          {% elif dept == 'Conversion' %}
            <i class="bi bi-arrow-repeat me-2"></i> Conversion
          {% elif dept == 'Marketing' %}
            <i class="bi bi-megaphone me-2"></i> Marketing
          {% elif dept == 'Retention' %}
            <i class="bi bi-heart me-2"></i> Retention
          {% elif dept == 'Research' %}
            <i class="bi bi-search me-2"></i> Research
          {% elif dept == 'Operation' %}
            <i class="bi bi-gear me-2"></i> Operation
          {% elif dept == 'Developers' %}
            <i class="bi bi-code-slash me-2"></i> Developers
          {% elif dept == 'Management' %}
            <i class="bi bi-person-badge me-2"></i> Management
          {% endif %}
        </a>
      </li>
      {% endfor %}
    </ul>
    
    <div class="tab-content bg-white rounded-bottom border-start border-end border-bottom" id="agentsTabContent">
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <!-- Overview Content -->
        <div class="p-4">
          <div class="row">
            <div class="col-12">
              <h5 class="mb-3">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Employee Performance Overview
              </h5>
              <p class="text-muted">Comprehensive view of employee performance, salary calculations, and department summaries.</p>
              
              <!-- Department Summary Cards -->
              <div class="row g-3 mt-3">
                {% for dept_name, dept_data in departments.items() %}
                <div class="col-md-6 col-lg-4">
                  <div class="department-card">
                    <div class="department-header">
                      <h6 class="mb-1">{{ dept_name }}</h6>
                      <span class="badge bg-{% if dept_data.active_agents > 0 %}success{% else %}secondary{% endif %}">
                        {{ dept_data.active_agents }}/{{ dept_data.total_agents }} Active
                      </span>
                    </div>
                    <div class="department-stats">
                      <div class="stat-item">
                        <span class="stat-label">Total Salary:</span>
                        <span class="stat-value">₺{{ "{:,.0f}".format(dept_data.total_final_salary) }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">USD Salary:</span>
                        <span class="stat-value">${{ "{:,.0f}".format(dept_data.total_usd_salary) }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Deductions:</span>
                        <span class="stat-value text-danger">₺{{ "{:,.0f}".format(dept_data.total_deducted) }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Advances:</span>
                        <span class="stat-value text-warning">₺{{ "{:,.0f}".format(dept_data.total_advance) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee List -->
  {% if agents %}
  <div class="employee-list mt-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-people text-primary me-2"></i>
          Employee List
          {% if selected_department and selected_department != 'overview' %}
            - {{ selected_department }}
          {% endif %}
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Company</th>
                <th>Stage Name</th>
                <th>Status</th>
                <th>Net Salary</th>
                <th>Deductions</th>
                <th>Advances</th>
                <th>Final Salary</th>
                <th>USD Rate</th>
                <th>USD Salary</th>
                <th>Insurance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for agent in agents %}
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm me-2">
                      <i class="bi bi-person-circle text-muted"></i>
                    </div>
                    <div>
                      <div class="fw-semibold">{{ agent.name }}</div>
                      <small class="text-muted">ID: {{ agent.id }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-primary">{{ agent.department }}</span>
                </td>
                <td>{{ agent.company_name }}</td>
                <td>{{ agent.stage_name }}</td>
                <td>
                  <span class="badge bg-{% if agent.working_status == 'active' %}success{% else %}secondary{% endif %}">
                    {{ agent.working_status|title }}
                  </span>
                </td>
                <td class="text-end">₺{{ "{:,.0f}".format(agent.net_salary) }}</td>
                <td class="text-end text-danger">₺{{ "{:,.0f}".format(agent.deducted_amount) }}</td>
                <td class="text-end text-warning">₺{{ "{:,.0f}".format(agent.advance) }}</td>
                <td class="text-end fw-bold">₺{{ "{:,.0f}".format(agent.final_salary) }}</td>
                <td class="text-end">{{ "{:.4f}".format(agent.usd_rate) }}</td>
                <td class="text-end">${{ "{:,.0f}".format(agent.salary_in_usd) }}</td>
                <td>
                  <span class="badge bg-{% if agent.insurance %}success{% else %}secondary{% endif %}">
                    {{ 'Yes' if agent.insurance else 'No' }}
                  </span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{{ url_for('analytics.edit_employee', employee_id=agent.id) }}" 
                       class="btn btn-outline-primary btn-sm" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            onclick="deleteEmployee({{ agent.id }}, '{{ agent.name }}')" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="empty-state mt-4">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-3 text-muted">No Employees Found</h5>
        <p class="text-muted">Start by adding your first employee to the system.</p>
        <a href="{{ url_for('analytics.add_employee') }}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>Add First Employee
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
.agents-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1rem;
}

.agents-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #e9ecef;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.metrics-row {
  margin-bottom: 2rem;
}

.metric-card {
  background: #ffffff;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1.25rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: all 0.2s ease;
  height: 100%;
}

.metric-card:hover {
  border-color: #dee2e6;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.metric-icon {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.metric-icon i {
  font-size: 1.25rem;
}

.metric-content {
  flex: 1;
}

.metric-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #212529;
  line-height: 1.2;
}

.metric-label {
  font-size: 0.875rem;
  color: #6c757d;
  margin-top: 0.25rem;
}

.tab-container {
  background: #ffffff;
  border-radius: 8px;
  overflow: hidden;
}

.nav-tabs {
  background: transparent;
  padding: 0;
  margin: 0;
  border-bottom: 1px solid #e9ecef;
}

.nav-tabs .nav-link {
  border: none;
  color: #6c757d;
  font-weight: 400;
  padding: 0.75rem 1rem;
  transition: color 0.15s ease;
  outline: none !important;
  box-shadow: none !important;
  background: transparent;
  position: relative;
  text-decoration: none;
}

.nav-tabs .nav-link:focus {
  outline: none !important;
  box-shadow: none !important;
  border: none !important;
  background: transparent !important;
}

.nav-tabs .nav-link:hover {
  color: #495057;
  background: transparent;
  outline: none !important;
  box-shadow: none !important;
}

.nav-tabs .nav-link.active {
  color: #0d6efd;
  background: transparent;
  border: none;
  outline: none !important;
  box-shadow: none !important;
}

.nav-tabs .nav-link.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: #0d6efd;
}

.nav-tabs .nav-link.active:focus {
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}

/* Remove any remaining focus indicators */
.nav-tabs .nav-link:focus-visible {
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}

/* Remove Bootstrap's default focus styles */
.nav-tabs .nav-link:focus,
.nav-tabs .nav-link:focus-visible,
.nav-tabs .nav-link:active {
  outline: none !important;
  box-shadow: none !important;
  border: none !important;
  background: transparent !important;
}

.tab-content {
  padding: 0;
}

.department-card {
  background: #ffffff;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1.25rem;
  transition: all 0.2s ease;
  height: 100%;
}

.department-card:hover {
  border-color: #dee2e6;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.department-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.department-stats {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stat-label {
  font-size: 0.875rem;
  color: #6c757d;
}

.stat-value {
  font-weight: 600;
  color: #212529;
}

.employee-list .table th {
  border-top: none;
  font-weight: 600;
  color: #495057;
  font-size: 0.875rem;
}

.employee-list .table td {
  vertical-align: middle;
  border-top: 1px solid #f8f9fa;
}

.avatar-sm {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #f8f9fa;
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-state {
  text-align: center;
}

@media (max-width: 768px) {
  .agents-header {
    padding: 1rem;
  }
  
  .metric-card {
    padding: 1rem;
  }
  
  .metric-value {
    font-size: 1.25rem;
  }
  
  .nav-tabs .nav-link {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }
  
  .department-card {
    padding: 1rem;
  }
}
</style>

<script>
function changeDateRange(days) {
    // Implementation for date range change
    console.log('Changing date range to', days, 'days');
    // Add your date range change logic here
}

function deleteEmployee(employeeId, employeeName) {
    if (confirm(`Are you sure you want to delete employee "${employeeName}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_employee/${employeeId}`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 