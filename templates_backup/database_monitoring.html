{% extends "base.html" %}

{% block title %}Database Monitoring - PipLine{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-database me-2"></i>Database Monitoring
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-success" onclick="createBackup()">
                        <i class="bi bi-download"></i> Create Backup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Health Status -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-success">
                                <i class="bi bi-check-circle text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Database Status</h6>
                            <p class="mb-0 text-success" id="db-status">Healthy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-info">
                                <i class="bi bi-activity text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Active Connections</h6>
                            <p class="mb-0" id="active-connections">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-warning">
                                <i class="bi bi-exclamation-triangle text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Slow Queries</h6>
                            <p class="mb-0" id="slow-queries-count">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-primary">
                                <i class="bi bi-hdd text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Total Backups</h6>
                            <p class="mb-0" id="total-backups">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Statistics and Backup Management -->
    <div class="row">
        <!-- Database Statistics -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>Database Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Connection Pool</h6>
                            <ul class="list-unstyled">
                                <li><strong>Pool Size:</strong> <span id="pool-size">0</span></li>
                                <li><strong>Checked Out:</strong> <span id="checked-out">0</span></li>
                                <li><strong>Checked In:</strong> <span id="checked-in">0</span></li>
                                <li><strong>Overflow:</strong> <span id="overflow">0</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total Connections:</strong> <span id="total-connections">0</span></li>
                                <li><strong>Slow Queries:</strong> <span id="slow-queries-total">0</span></li>
                                <li><strong>Connection Time:</strong> <span id="connection-time">0ms</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Slow Queries Table -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>Recent Slow Queries
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm" id="slow-queries-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Query</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No slow queries detected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Backup Management -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hdd me-2"></i>Backup Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Backup Statistics</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total Backups:</strong> <span id="backup-count">0</span></li>
                            <li><strong>Total Size:</strong> <span id="backup-size">0 MB</span></li>
                            <li><strong>Old Backups:</strong> <span id="old-backups">0</span></li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-success btn-sm w-100 mb-2" onclick="createBackup()">
                            <i class="bi bi-download"></i> Create Backup
                        </button>
                        <button type="button" class="btn btn-warning btn-sm w-100" onclick="cleanupBackups()">
                            <i class="bi bi-trash"></i> Cleanup Old Backups
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Recent Backups</h6>
                        <div class="list-group list-group-flush" id="backups-list">
                            <div class="text-center text-muted">No backups found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Database Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="backupName" class="form-label">Backup Name (Optional)</label>
                    <input type="text" class="form-control" id="backupName" placeholder="Leave empty for auto-generated name">
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This will create a complete backup of the database. The process may take a few moments.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmBackup()">
                    <i class="bi bi-download"></i> Create Backup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Restore Database</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will replace the current database with the selected backup. 
                    A backup of the current database will be created before restoration.
                </div>
                <div class="mb-3">
                    <label for="restoreBackup" class="form-label">Select Backup to Restore</label>
                    <select class="form-select" id="restoreBackup">
                        <option value="">Select a backup...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRestore()">
                    <i class="bi bi-arrow-clockwise"></i> Restore Database
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let backupModal, restoreModal;

$(document).ready(function() {
    backupModal = new bootstrap.Modal(document.getElementById('backupModal'));
    restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
    
    // Load initial data
    refreshStats();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshStats, 30000);
});

function refreshStats() {
    // Load database statistics
    $.get('/api/database/stats')
        .done(function(data) {
            updateDatabaseStats(data);
        })
        .fail(function(xhr) {
            console.error('Failed to load database stats:', xhr.responseText);
        });
    
    // Load slow queries
    $.get('/api/database/slow-queries')
        .done(function(data) {
            updateSlowQueries(data.slow_queries);
        })
        .fail(function(xhr) {
            console.error('Failed to load slow queries:', xhr.responseText);
        });
    
    // Load backup statistics
    $.get('/api/database/backup/stats')
        .done(function(data) {
            updateBackupStats(data);
        })
        .fail(function(xhr) {
            console.error('Failed to load backup stats:', xhr.responseText);
        });
    
    // Load backup list
    $.get('/api/database/backups')
        .done(function(data) {
            updateBackupList(data.backups);
        })
        .fail(function(xhr) {
            console.error('Failed to load backups:', xhr.responseText);
        });
}

function updateDatabaseStats(data) {
    $('#active-connections').text(data.active_connections || 0);
    $('#slow-queries-count').text(data.slow_queries_recent || 0);
    $('#pool-size').text(data.pool_size || 0);
    $('#checked-out').text(data.checked_out || 0);
    $('#checked-in').text(data.checked_in || 0);
    $('#overflow').text(data.overflow || 0);
    $('#total-connections').text(data.total_connections || 0);
    $('#slow-queries-total').text(data.slow_queries_count || 0);
    $('#connection-time').text((data.connection_time * 1000).toFixed(2) + 'ms');
    
    // Update status
    const status = data.status || 'unknown';
    $('#db-status').text(status.charAt(0).toUpperCase() + status.slice(1));
    $('#db-status').removeClass('text-success text-warning text-danger')
        .addClass(status === 'healthy' ? 'text-success' : 
                 status === 'warning' ? 'text-warning' : 'text-danger');
}

function updateSlowQueries(queries) {
    const tbody = $('#slow-queries-table tbody');
    tbody.empty();
    
    if (queries && queries.length > 0) {
        queries.forEach(query => {
            const row = `
                <tr>
                    <td>${new Date(query.timestamp).toLocaleString()}</td>
                    <td><span class="badge bg-warning">${(query.execution_time * 1000).toFixed(2)}ms</span></td>
                    <td><code class="small">${query.statement.substring(0, 100)}${query.statement.length > 100 ? '...' : ''}</code></td>
                </tr>
            `;
            tbody.append(row);
        });
    } else {
        tbody.append('<tr><td colspan="3" class="text-center text-muted">No slow queries detected</td></tr>');
    }
}

function updateBackupStats(data) {
    $('#total-backups').text(data.total_backups || 0);
    $('#backup-count').text(data.total_backups || 0);
    $('#backup-size').text(formatBytes(data.total_size || 0));
    $('#old-backups').text(data.old_backups_count || 0);
}

function updateBackupList(backups) {
    const container = $('#backups-list');
    container.empty();
    
    if (backups && backups.length > 0) {
        backups.slice(0, 5).forEach(backup => {
            const item = `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">${new Date(backup.created_at).toLocaleDateString()}</small>
                        <br>
                        <strong>${backup.filename}</strong>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${formatBytes(backup.size)}</small>
                        <br>
                        <button class="btn btn-sm btn-outline-danger" onclick="restoreBackup('${backup.filename}')">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            `;
            container.append(item);
        });
    } else {
        container.append('<div class="text-center text-muted">No backups found</div>');
    }
}

function createBackup() {
    backupModal.show();
}

function confirmBackup() {
    const backupName = $('#backupName').val();
    const data = backupName ? { backup_name: backupName } : {};
    
    $.post('/api/database/backup', JSON.stringify(data), 'json')
        .done(function(response) {
            if (response.success) {
                showAlert('Backup created successfully!', 'success');
                backupModal.hide();
                refreshStats();
            } else {
                showAlert('Backup failed: ' + (response.error || 'Unknown error'), 'danger');
            }
        })
        .fail(function(xhr) {
            showAlert('Backup failed: ' + xhr.responseText, 'danger');
        });
}

function cleanupBackups() {
    if (confirm('Are you sure you want to delete old backups? This action cannot be undone.')) {
        $.post('/api/database/backup/cleanup', '{}', 'json')
            .done(function(response) {
                if (response.success) {
                    showAlert(`Cleanup completed: ${response.deleted_count} files deleted`, 'success');
                    refreshStats();
                } else {
                    showAlert('Cleanup failed: ' + (response.error || 'Unknown error'), 'danger');
                }
            })
            .fail(function(xhr) {
                showAlert('Cleanup failed: ' + xhr.responseText, 'danger');
            });
    }
}

function restoreBackup(filename) {
    $('#restoreBackup').val(filename);
    restoreModal.show();
}

function confirmRestore() {
    const filename = $('#restoreBackup').val();
    if (!filename) {
        showAlert('Please select a backup to restore', 'warning');
        return;
    }
    
    if (confirm('Are you sure you want to restore the database? This will replace all current data.')) {
        $.post(`/api/database/backup/${filename}`, '{}', 'json')
            .done(function(response) {
                if (response.success) {
                    showAlert('Database restored successfully!', 'success');
                    restoreModal.hide();
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert('Restore failed: ' + (response.error || 'Unknown error'), 'danger');
                }
            })
            .fail(function(xhr) {
                showAlert('Restore failed: ' + xhr.responseText, 'danger');
            });
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').prepend(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %} 