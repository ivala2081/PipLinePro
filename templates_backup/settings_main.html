{% extends "base.html" %}
{% block title %}Settings - PipLine Treasury System{% endblock %}
{% block content %}
<div class="page-container">
  <!-- Enhanced Header -->
  <div class="page-header">
    <div class="d-flex">
      <div>
        <h1 class="h2 mb-1 text-dark fw-bold">
          <i class="bi bi-gear text-primary me-2"></i>
          {{ _('System Settings') }}
        </h1>
        <p class="text-muted mb-0 small">
          {{ _('Manage your account, security, and system configuration') }}
        </p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="status-indicator">
          <span class="status-dot bg-success"></span>
          <span class="status-text small text-muted">Active</span>
        </div>
        <div class="text-end">
          <div class="small text-muted">User</div>
          <div class="small fw-semibold">{{ current_user.username }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Navigation Tabs -->
  <div class="settings-tabs-section mb-4">
    <div class="settings-tabs-card">
      <div class="settings-tabs-header">
        <h3 class="settings-tabs-title">
          <i class="bi bi-list text-primary me-2"></i>
          Settings Categories
        </h3>
        <p class="settings-tabs-subtitle">Choose a category to configure</p>
      </div>
      <div class="settings-tabs-content">
        <ul class="nav nav-tabs settings-tabs" id="settingsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
              <i class="bi bi-person-circle"></i>
              <span>Profile & Security</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab">
              <i class="bi bi-gear"></i>
              <span>Preferences</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
              <i class="bi bi-sliders"></i>
              <span>System Configuration</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
              <i class="bi bi-laptop"></i>
              <span>Active Sessions</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
              <i class="bi bi-info-circle"></i>
              <span>About & Support</span>
            </button>
          </li>
          {% if current_user.is_any_admin() %}
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">
              <i class="bi bi-shield-check"></i>
              <span>Admin Management</span>
            </button>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="settingsTabContent">
    
    <!-- Profile & Security Tab -->
    <div class="tab-pane fade show active" id="profile" role="tabpanel">
      <div class="settings-content">
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center">
                  <div class="me-2"><i class="bi bi-person-circle fs-3 text-primary"></i></div>
                  <div>
                    <h5 class="mb-0 fw-semibold">Profile</h5>
                    <small class="text-muted">Update your profile picture</small>
                  </div>
                </div>
              </div>
              <div class="settings-card-content">
                <form id="profile-pic-form" enctype="multipart/form-data" method="POST" action="{{ url_for('auth.upload_profile_picture') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="d-flex flex-column align-items-center mb-3">
                    {% if current_user.profile_picture %}
                      <img src="{{ url_for('static', filename='uploads/' ~ current_user.profile_picture) }}" alt="Profile Picture" class="rounded-circle border border-2" style="width: 120px; height: 120px; object-fit: cover;">
                    {% else %}
                      <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border border-2" style="width: 120px; height: 120px;">
                        <i class="bi bi-person-circle text-secondary fs-1"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="mb-3">
                    <label for="profilePic" class="form-label fw-semibold small">Upload New Picture</label>
                    <input class="form-control" type="file" id="profilePic" name="profilePic" accept="image/*">
                    <div class="form-text">JPG, PNG. Max 2MB</div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100 fw-semibold">Update Picture</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center">
                  <div class="me-2"><i class="bi bi-shield-lock fs-3 text-success"></i></div>
                  <div>
                    <h5 class="mb-0 fw-semibold">Security</h5>
                    <small class="text-muted">Change your password</small>
                  </div>
                </div>
              </div>
              <div class="settings-card-content">
                <form id="password-change-form" method="POST" action="{{ url_for('auth.change_password') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label fw-semibold small">Current Password</label>
                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="newPassword" class="form-label fw-semibold small">New Password</label>
                    <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label fw-semibold small">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                  </div>
                  <button type="submit" class="btn btn-success w-100 fw-semibold">Change Password</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preferences Tab -->
    <div class="tab-pane fade" id="preferences" role="tabpanel">
      <div class="settings-content">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="d-flex align-items-center">
              <div class="me-2"><i class="bi bi-gear fs-3 text-primary"></i></div>
              <div>
                <h5 class="mb-0 fw-semibold">{{ _('User Preferences') }}</h5>
                <small class="text-muted">{{ _('Customize your experience') }}</small>
              </div>
            </div>
          </div>
          <div class="settings-card-content">
            <form method="POST" action="{{ url_for('settings.save_preferences') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="landing_page" value="{{ user_settings.landing_page if user_settings else 'dashboard' }}">
              <input type="hidden" name="table_page_size" value="{{ user_settings.table_page_size if user_settings else 25 }}">
              <input type="hidden" name="table_density" value="{{ user_settings.table_density if user_settings else 'comfortable' }}">
              <input type="hidden" name="font_size" value="{{ user_settings.font_size if user_settings else 'medium' }}">
              <input type="hidden" name="color_scheme" value="{{ user_settings.color_scheme if user_settings else 'default' }}">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="language" class="form-label fw-semibold">{{ _('Language') }}</label>
                    <select class="form-select" id="language" name="language">
                      <option value="en" {% if user_settings and user_settings.language == 'en' %}selected{% endif %}>English</option>
                      <option value="tr" {% if user_settings and user_settings.language == 'tr' %}selected{% endif %}>Türkçe</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="timezone" class="form-label fw-semibold">Timezone</label>
                    <select class="form-select" id="timezone" name="timezone">
                      <option value="UTC">UTC</option>
                      <option value="Europe/Istanbul">Europe/Istanbul</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="dateFormat" class="form-label fw-semibold">Date Format</label>
                    <select class="form-select" id="dateFormat" name="dateFormat">
                      <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                      <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                      <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="currency" class="form-label fw-semibold">Currency</label>
                    <select class="form-select" id="currency" name="currency">
                      <option value="USD">USD ($)</option>
                      <option value="EUR">EUR (€)</option>
                      <option value="TRY">TRY (₺)</option>
                    </select>
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">{{ _('Save Preferences') }}</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- System Configuration Tab -->
    <div class="tab-pane fade" id="system" role="tabpanel">
      <div class="settings-content">
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center">
                  <div class="me-2"><i class="bi bi-sliders fs-3 text-warning"></i></div>
                  <div>
                    <h5 class="mb-0 fw-semibold">System Configuration</h5>
                    <small class="text-muted">Advanced system settings</small>
                  </div>
                </div>
              </div>
              <div class="settings-card-content">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Database Status</label>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">Connected</span>
                        <small class="text-muted">SQLite Database</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">System Version</label>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-info me-2">v1.0.0</span>
                        <small class="text-muted">Latest</small>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Backup Status</label>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">Enabled</span>
                        <small class="text-muted">Auto backup active</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Security Level</label>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-warning me-2">High</span>
                        <small class="text-muted">Enhanced security</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-6">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center">
                  <div class="me-2"><i class="bi bi-list-ul fs-3 text-primary"></i></div>
                  <div>
                    <h5 class="mb-0 fw-semibold">Dropdown Management</h5>
                    <small class="text-muted">Manage form dropdown options</small>
                  </div>
                </div>
              </div>
              <div class="settings-card-content">
                <div class="mb-3">
                  <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Add, edit, or remove options from transaction form dropdowns including:
                  </p>
                  <ul class="list-unstyled small text-muted mb-3">
                    <li><i class="bi bi-check-circle text-success me-2"></i>Payment Methods</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Currencies</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>IBAN Numbers</li>
                  </ul>
                </div>
                <a href="{{ url_for('settings.settings_dropdowns') }}" class="btn btn-primary w-100">
                  <i class="bi bi-gear me-2"></i>
                  Manage Dropdown Options
                </a>
              </div>
            </div>
          </div>
          
          <!-- Fixed PSP Options Section -->
          <div class="col-lg-6">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center">
                  <div class="me-2"><i class="bi bi-credit-card fs-3 text-success"></i></div>
                  <div>
                    <h5 class="mb-0 fw-semibold">PSP Options (Fixed)</h5>
                    <small class="text-muted">Payment Service Providers from database</small>
                  </div>
                </div>
              </div>
              <div class="settings-card-content">
                <div class="mb-3">
                  <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    PSP options are automatically generated from your transaction data with default commission rates:
                  </p>
                  {% if fixed_psp_options %}
                    <div class="psp-options-list">
                      {% set seen_psps = [] %}
                      {% for psp in fixed_psp_options %}
                        {% if psp.value not in seen_psps %}
                          {% set _ = seen_psps.append(psp.value) %}
                          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                              <span class="fw-semibold">{{ psp.value }}</span>
                              <small class="text-muted d-block">Commission: {{ "%.1f"|format(psp.commission_rate * 100) }}%</small>
                            </div>
                            <span class="badge bg-success">Fixed</span>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-center py-3">
                      <i class="bi bi-inbox text-muted fs-1"></i>
                      <p class="text-muted mb-0">No PSP data found in transactions</p>
                    </div>
                  {% endif %}
                </div>
                <div class="alert alert-info small mb-0">
                  <i class="bi bi-lightbulb me-1"></i>
                  <strong>Note:</strong> PSP options are automatically managed based on your transaction history. Commission rates can be adjusted in the dropdown management section.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Fixed Company Options Section -->
      <div class="row">
        <div class="col-lg-6">
          <div class="settings-card">
            <div class="settings-card-header">
              <div class="d-flex align-items-center">
                <div class="me-2"><i class="bi bi-building fs-3 text-primary"></i></div>
                <div>
                  <h5 class="mb-0 fw-semibold">Company Options (Fixed)</h5>
                  <small class="text-muted">Companies from database</small>
                </div>
              </div>
            </div>
            <div class="settings-card-content">
              <div class="mb-3">
                <p class="text-muted small mb-3">
                  <i class="bi bi-info-circle me-1"></i>
                  Company options are automatically generated from your transaction data:
                </p>
                {% if fixed_company_options %}
                  <div class="company-options-list">
                    {% set seen_companies = [] %}
                    {% for company in fixed_company_options %}
                      {% if company.value not in seen_companies %}
                        {% set _ = seen_companies.append(company.value) %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                          <div>
                            <span class="fw-semibold">{{ company.value }}</span>
                          </div>
                          <span class="badge bg-primary">Fixed</span>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-center py-3">
                    <i class="bi bi-inbox text-muted fs-1"></i>
                    <p class="text-muted mb-0">No company data found in transactions</p>
                  </div>
                {% endif %}
              </div>
              <div class="alert alert-info small mb-0">
                <i class="bi bi-lightbulb me-1"></i>
                <strong>Note:</strong> Company options are automatically managed based on your transaction history.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Sessions Tab -->
    <div class="tab-pane fade" id="sessions" role="tabpanel">
      <div class="settings-content">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="d-flex align-items-center">
              <div class="me-2"><i class="bi bi-laptop fs-3 text-info"></i></div>
              <div>
                <h5 class="mb-0 fw-semibold">Active Sessions</h5>
                <small class="text-muted">Manage your active sessions</small>
              </div>
            </div>
          </div>
          <div class="settings-card-content">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>Location</th>
                    <th>Last Active</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <i class="bi bi-laptop me-2"></i>
                        <span>Current Session</span>
                      </div>
                    </td>
                    <td>Local</td>
                    <td>Just now</td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-danger">Terminate</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- About & Support Tab -->
    <div class="tab-pane fade" id="about" role="tabpanel">
      <div class="settings-content">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="d-flex align-items-center">
              <div class="me-2"><i class="bi bi-info-circle fs-3 text-primary"></i></div>
              <div>
                <h5 class="mb-0 fw-semibold">About & Support</h5>
                <small class="text-muted">System information and support</small>
              </div>
            </div>
          </div>
          <div class="settings-card-content">
            <div class="row">
              <div class="col-md-6">
                <h6 class="fw-semibold">System Information</h6>
                <ul class="list-unstyled">
                  <li><strong>Version:</strong> 1.0.0</li>
                  <li><strong>Framework:</strong> Flask</li>
                  <li><strong>Database:</strong> SQLite</li>
                  <li><strong>Python:</strong> 3.9+</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="fw-semibold">Support</h6>
                <ul class="list-unstyled">
                  <li><i class="bi bi-envelope me-2"></i>support@pipeline.com</li>
                  <li><i class="bi bi-telephone me-2"></i>+90 555 123 4567</li>
                  <li><i class="bi bi-chat me-2"></i>Live Chat</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Management Tab -->
    {% if current_user.is_any_admin() %}
    <div class="tab-pane fade" id="admin" role="tabpanel">
      <div class="settings-content">
        <div class="row g-4">
          <div class="col-12">
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h5 class="mb-0 fw-semibold">
                      <i class="bi bi-shield-check text-primary me-2"></i>
                      Administrator Management
                    </h5>
                    <small class="text-muted">Manage admin accounts and permissions</small>
                  </div>
                  <a href="{{ url_for('admin_management.admin_management') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-gear me-1"></i>
                    Manage Admins
                  </a>
                </div>
              </div>
              <div class="settings-card-content">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Your Admin Level</label>
                      <div class="d-flex align-items-center">
                        {% if current_user.is_main_admin() %}
                          <span class="badge bg-danger me-2">Main Administrator</span>
                        {% elif current_user.is_secondary_admin() %}
                          <span class="badge bg-warning me-2">Secondary Administrator</span>
                        {% elif current_user.is_sub_admin() %}
                          <span class="badge bg-info me-2">Sub Administrator</span>
                        {% endif %}
                        <small class="text-muted">{{ current_user.get_admin_title() }}</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Permissions</label>
                      <div class="d-flex align-items-center">
                        {% if current_user.is_main_admin() %}
                          <span class="badge bg-success me-2">Full Access</span>
                        {% elif current_user.is_secondary_admin() %}
                          <span class="badge bg-warning me-2">Most Access</span>
                        {% elif current_user.is_sub_admin() %}
                          <span class="badge bg-info me-2">Limited Access</span>
                        {% endif %}
                        <small class="text-muted">Based on level</small>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Admin Hierarchy</label>
                      <div class="admin-hierarchy-preview">
                        <div class="hierarchy-item">
                          <i class="bi bi-shield-fill-check text-danger me-2"></i>
                          <span class="fw-semibold">Main Administrator</span>
                          <small class="text-muted ms-2">- Full system access, can manage all admins</small>
                        </div>
                        <div class="hierarchy-item">
                          <i class="bi bi-shield-check text-warning me-2"></i>
                          <span class="fw-semibold">Secondary Administrator</span>
                          <small class="text-muted ms-2">- Most system access, can manage sub-admins</small>
                        </div>
                        <div class="hierarchy-item">
                          <i class="bi bi-shield text-info me-2"></i>
                          <span class="fw-semibold">Sub Administrator</span>
                          <small class="text-muted ms-2">- Limited access, specific permissions only</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <div class="alert alert-info">
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>Admin Management:</strong> Click "Manage Admins" to access the full admin management interface where you can create, edit, and manage administrator accounts and their permissions.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}