{% block content %}
<div id="psp-ledger-tab-content" class="minimal-ledger">
  {% for summary in summary_data %}
    <div class="ledger-day-container" data-date="{{ summary.date.strftime('%Y-%m-%d') }}">
      <!-- Minimal Day Header -->
      <div class="day-header">
        <div class="header-content">
          <h3 class="day-title">{{ summary.date.strftime('%A, %B %d, %Y') }}</h3>
          <div class="day-meta">
            <span class="psp-count">{{ summary.totals.total_psp }} PSP</span>
            <span class="separator">•</span>
            <span class="total-volume">₺{{ summary.totals['toplam']|format_number }}</span>
          </div>
        </div>
        <div class="header-stats">
          <div class="stat">
            <span class="stat-value">{{ summary.totals['net']|format_number }}</span>
            <span class="stat-label">Net</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ summary.totals['komisyon']|format_number }}</span>
            <span class="stat-label">Commission</span>
          </div>
        </div>
      </div>

      <!-- Clean PSP Table -->
      <div class="table-container">
        <table class="ledger-table">
          <thead>
            <tr>
              <th>PSP</th>
              <th class="text-right">Deposit</th>
              <th class="text-right">Withdraw</th>
              <th class="text-right">Total</th>
              <th class="text-right">Commission</th>
              <th class="text-right">Net</th>
              <th class="text-right">Allocation</th>
              <th class="text-right">Rollover</th>
              <th class="text-center">Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for psp, p in summary.psps.items() %}
              <tr class="psp-row">
                <td class="psp-cell">
                  <div class="psp-info">
                    <span class="psp-name">{{ psp }}</span>
                    <span class="psp-date">{{ summary.date.strftime('%m/%d') }}</span>
                  </div>
                </td>
                <td class="text-right amount-positive">{{ p['deposit']|format_number }}</td>
                <td class="text-right amount-negative">{{ p['withdraw']|format_number }}</td>
                <td class="text-right amount-total">{{ p['toplam']|format_number }}</td>
                <td class="text-right amount-commission">{{ p['komisyon']|format_number }}</td>
                <td class="text-right amount-net">{{ p['net']|format_number }}</td>
                <td class="text-right allocation-cell">
                  <div class="allocation-input">
                    <input type="number" 
                           step="0.01" 
                           class="allocation-field" 
                           value="{{ p['allocation']|default('') }}"
                           data-date="{{ summary.date.strftime('%Y-%m-%d') }}"
                           data-psp="{{ psp }}"
                           data-net="{{ p['net'] }}"
                           placeholder="0.00">
                    <div class="save-indicator">
                      <i class="bi bi-check-circle-fill success-icon"></i>
                      <i class="bi bi-arrow-clockwise loading-icon"></i>
                    </div>
                  </div>
                </td>
                <td class="text-right amount-rollover">{{ (p['net'] - p['allocation']|default(0))|format_number }}</td>
                <td class="text-center status-cell">
                  {% set rollover_amount = (p['net'] - p['allocation']|default(0)) %}
                  {% set net_amount = p['net']|float %}
                  {% if rollover_amount <= 0 %}
                    <span class="status-badge status-paid">Paid</span>
                  {% elif rollover_amount < (net_amount * 0.1) %}
                    <span class="status-badge status-almost-paid">Almost Paid</span>
                  {% else %}
                    <span class="status-badge status-unpaid">Unpaid</span>
                  {% endif %}
                </td>
                <td class="text-center action-cell">
                  <a href="{{ url_for('analytics.view_psp_track', psp=psp, date=summary.date) }}" 
                     class="action-link"
                     data-psp="{{ psp }}"
                     data-date="{{ summary.date.strftime('%Y-%m-%d') }}">
                    <i class="bi bi-eye"></i>
                    <span class="action-text">Show Details</span>
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Minimal Summary -->
      <div class="day-summary">
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Total Volume</span>
            <span class="summary-value">{{ summary.totals['toplam']|format_number }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Net Position</span>
            <span class="summary-value">{{ summary.totals['net']|format_number }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Commission</span>
            <span class="summary-value">{{ summary.totals['komisyon']|format_number }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Carry Over</span>
            <span class="summary-value">{{ summary.totals['carry_over']|format_number }}</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- PSP Allocation Fix Script -->
<script src="{{ url_for('static', filename='js/psp_allocation_fix.js') }}"></script>

<!-- PSP Details Link Debug Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('PSP Ledger Content loaded');
    
    // Add click event listeners to all Show Details links
    document.querySelectorAll('.action-link').forEach(link => {
        link.addEventListener('click', function(e) {
            const psp = this.getAttribute('data-psp');
            const date = this.getAttribute('data-date');
            const href = this.getAttribute('href');
            
            console.log('Show Details clicked:', {
                psp: psp,
                date: date,
                href: href
            });
            
            // Ensure the link works by checking if href is valid
            if (!href || href === '#') {
                e.preventDefault();
                console.error('Invalid href for PSP details link');
                alert('Error: Invalid link for PSP details');
                return;
            }
            
            // Log that we're navigating to the details page
            console.log('Navigating to PSP details page...');
        });
    });
    
    // Log all action links found
    const actionLinks = document.querySelectorAll('.action-link');
    console.log(`Found ${actionLinks.length} Show Details links`);
    
    actionLinks.forEach((link, index) => {
        const psp = link.getAttribute('data-psp');
        const date = link.getAttribute('data-date');
        const href = link.getAttribute('href');
        console.log(`Link ${index + 1}: PSP=${psp}, Date=${date}, Href=${href}`);
    });
});
</script>

{% endblock %} 