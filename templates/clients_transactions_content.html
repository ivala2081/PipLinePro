<div class="p-4">
  <!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css">
  
  <!-- CSS styles included in main bundle -->
  
  

  <div class="card">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4>
            <i class="bi bi-people-fill me-2"></i>
            Client Transactions
          </h4>
          <p>Professional transaction management with advanced filtering</p>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('transactions.add_transaction') }}" class="btn btn-primary btn-sm" title="Add new transaction">
            <i class="bi bi-plus-circle me-1"></i>
            <span class="d-none d-md-inline">Add Transaction</span>
            <span class="d-md-none">Add</span>
          </a>
          <button class="btn btn-light btn-sm" onclick="toggleFilters()">
            <i class="bi bi-funnel me-1"></i>
            <span class="d-none d-md-inline">Filters</span>
          </button>
          <button class="btn btn-export btn-sm" onclick="exportTable()">
            <i class="bi bi-download me-1"></i>
            <span class="d-none d-md-inline">{{ _("Export") }}</span>
          </button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Professional Filter Section -->
      <div id="filterSection" class="filter-section">
        <div class="filter-header">
          <h6>
            <i class="bi bi-funnel-fill text-primary me-2"></i>
            {{ _("Advanced Filters") }}
          </h6>
          <div class="filter-actions">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleFilterSection()">
              <i class="bi bi-chevron-up" id="filterToggleIcon"></i>
              <span id="filterToggleText">{{ _("Collapse") }}</span>
            </button>
          </div>
        </div>
        
        <div id="filterContent" class="filter-content">
          <form method="GET" class="row g-3" action="{{ url_for('transactions.clients', tab='transactions') }}">
            <input type="hidden" name="tab" value="{{ _("transactions") }}">
            <div class="col-lg-3 col-md-6">
              <label class="form-label">
                <i class="bi bi-person text-muted me-1"></i>
                {{ _("Client Name") }}
              </label>
              <select class="form-select" name="client" id="clientFilter">
                <option value="">{{ _("All Clients") }}</option>
                {% for client in available_clients %}
                <option value="{{ client }}" {% if selected_client == client %}selected{% endif %}>{{ client }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <label class="form-label">
                <i class="bi bi-credit-card text-muted me-1"></i>
                {{ _("Payment Method") }}
              </label>
              <select class="form-select" name="payment_method" id="paymentMethodFilter">
                <option value="">All {{ _("Payment Method") }}s</option>
                {% for pm in payment_methods %}
                <option value="{{ pm }}" {% if filter_payment==pm %}selected{% endif %}>{{ pm }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <label class="form-label">
                <i class="bi bi-tags text-muted me-1"></i>
                {{ _("Category") }}
              </label>
              <select class="form-select" name="category" id="categoryFilter">
                <option value="">{{ _("All Categories") }}</option>
                <option value="WD" {% if filter_category=='WD' %}selected{% endif %}>{{ _("WD (Withdraw)") }}</option>
                <option value="DEP" {% if filter_category=='DEP' %}selected{% endif %}>{{ _("DEP (Deposit)") }}</option>
              </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <label class="form-label">
                <i class="bi bi-bank text-muted me-1"></i>
                {{ _("PSP/KASA") }}
              </label>
              <select class="form-select" name="psp" id="pspFilter">
                <option value="">{{ _("All PSPs") }}</option>
                {% for psp in psps %}
                <option value="{{ psp }}" {% if filter_psp==psp %}selected{% endif %}>{{ psp }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
              <label class="form-label">
                <i class="bi bi-currency-dollar text-muted me-1"></i>
                {{ _("Currency") }}
              </label>
              <select class="form-select" name="currency" id="currencyFilter">
                <option value="">{{ _("All Currencies") }}</option>
                {% for curr in currencies %}
                <option value="{{ curr }}" {% if filter_currency==curr %}selected{% endif %}>{{ curr }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-12">
              <div class="filter-buttons">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search me-1"></i>
                  {{ _("Apply Filters") }}
                </button>
                <a href="{{ url_for('transactions.clients', tab='transactions') }}" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  {{ _("Reset") }}
                </a>
                <button type="button" class="btn btn-outline-info" onclick="exportFilteredData()">
                  <i class="bi bi-download me-1"></i>
                  {{ _("Export") }}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Clean Professional DataTable - No borders -->
      <div class="table-responsive-enhanced">
        <table id="clientsTable" class="table dataTable table-enhanced table-hover">
          <thead>
            <tr>
                      <th class="clients-table-style-232" >{{ _("#") }}</th>
        <th class="clients-table-style-7847" >{{ _("Client") }}</th>
        <th class="clients-table-style-2653" >{{ _("IBAN") }}</th>
        <th class="clients-table-style-3182" >{{ _("Payment") }}</th>
        <th class="clients-table-style-3182" >{{ _("Category") }}</th>
        <th class="clients-table-style-3182" >{{ _("Amount") }}</th>
        <th class="clients-table-style-3182" >{{ _("Commission") }}</th>
        <th class="clients-table-style-3182" >{{ _("Net Amount") }}</th>
        <th class="clients-table-style-6056" >{{ _("Currency") }}</th>
        <th class="clients-table-style-3182" >{{ _("PSP") }}</th>
        <th class="clients-table-style-3986" >{{ _("Actions") }}</th>
            </tr>
          </thead>
          <tbody>
            {% if transactions %}
              {% set ns = namespace(prev_date_str=None) %}
              {% for t in transactions %}
                {% set current_date_str = t.date.strftime('%Y-%m-%d') %}
                {% if ns.prev_date_str != current_date_str %}
                  {% set ns.prev_date_str = current_date_str %}
                  <!-- Enhanced Date Separator -->
                  <tr class="date-separator-row">
                    <td colspan="11" class="p-0">
                      <div class="date-separator">
                        <h6>
                          <i class="bi bi-calendar-event"></i>
                          {{ t.date.strftime('%d.%m.%Y') }}
                          <span class="transaction-count">
                            {{ transactions|selectattr('date', 'equalto', t.date)|list|length }} {{ _("transactions") }}
                          </span>
                          <button type="button" 
                                  class="btn btn-sm btn-outline-light ms-3 summary-btn" 
                                  title="{{ _('View Daily Summary') }}"
                                  data-date="{{ t.date.strftime('%Y-%m-%d') }}">
                            <i class="bi bi-bar-chart me-1"></i>
                            {{ _("Summary") }}
                          </button>
                        </h6>
                      </div>
                    </td>
                  </tr>
                {% endif %}
                
                <tr>
                  <td class="text-center">
                    <span class="row-number">{{ loop.index }}</span>
                  </td>
                  <td>
                    <div class="data-cell">
                      <div class="data-icon">
                        {{ t.client_name[0]|upper if t.client_name else '?' }}
                      </div>
                      <div class="data-content">
                        <div class="data-primary">{{ t.client_name or '{{ _("Unknown Client") }}' }}</div>
                        {% if t.company_order %}
                          <div class="data-secondary">{{ t.company_order }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if t.iban %}
                      <div class="code-container">
                        <code class="code-enhanced" title="{{ t.iban }}">
                          {{ t.iban[:8] }}...{{ t.iban[-4:] if t.iban|length > 12 else '' }}
                        </code>
                        <div class="code-tooltip">{{ t.iban }}</div>
                      </div>
                    {% else %}
                      <span class="data-missing">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if t.payment_method %}
                      <span class="badge-enhanced bg-info">
                        <i class="bi bi-credit-card me-1"></i>
                        {{ t.payment_method }}
                      </span>
                    {% else %}
                      <span class="data-missing">No {{ _("Payment Method") }}</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if t.category %}
                      {% if t.category == 'WD' %}
                        <span class="badge-enhanced bg-danger">
                          <i class="bi bi-arrow-down-circle me-1"></i>
                          {{ _("WD (Withdraw)") }}
                        </span>
                      {% elif t.category == 'DEP' %}
                        <span class="badge-enhanced bg-success">
                          <i class="bi bi-arrow-up-circle me-1"></i>
                          {{ _("DEP (Deposit)") }}
                        </span>
                      {% else %}
                        <span class="badge-enhanced bg-secondary">
                          <i class="bi bi-tag me-1"></i>
                          {{ t.category }}
                        </span>
                      {% endif %}
                    {% else %}
                      <span class="data-missing">No {{ _("Category") }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if t.amount %}
                      {% set amount = t.amount|safe_float %}
                      {% if t.category and t.category.upper() == 'WD' %}
                        <!-- WD (Withdraw) - Red color -->
                        <span class="amount-withdraw text-danger fw-bold">
                          <i class="bi bi-arrow-down-circle me-1"></i>
                          {{ t.amount|format_number }}
                        </span>
                      {% elif t.category and t.category.upper() == 'DEP' %}
                        <!-- DEP (Deposit) - Green color -->
                        <span class="amount-deposit text-success fw-bold">
                          <i class="bi bi-arrow-up-circle me-1"></i>
                          {{ t.amount|format_number }}
                        </span>
                      {% else %}
                        <!-- Default behavior for other categories -->
                        {% if amount|safe_compare('>=', 0) %}
                          <span class="amount-positive">
                            <i class="bi bi-arrow-up-circle me-1"></i>
                            {{ t.amount|format_number }}
                          </span>
                        {% else %}
                          <span class="amount-negative">
                            <i class="bi bi-arrow-down-circle me-1"></i>
                            {{ t.amount|format_number }}
                          </span>
                        {% endif %}
                      {% endif %}
                    {% else %}
                      <span class="data-missing">No Amount</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if t.commission %}
                      <span class="amount-commission">
                        <i class="bi bi-percent me-1"></i>
                        {{ t.commission|format_number }}
                      </span>
                    {% else %}
                      <span class="data-missing">No Commission</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if t.net_amount %}
                      {% set net_amount = t.net_amount|safe_float %}
                {% if net_amount|safe_compare('>=', 0) %}
                        <span class="amount-net">
                          <i class="bi bi-check-circle me-1"></i>
                          {{ t.net_amount|format_number }}
                        </span>
                      {% else %}
                        <span class="amount-negative">
                          <i class="bi bi-x-circle me-1"></i>
                          {{ t.net_amount|format_number }}
                        </span>
                      {% endif %}
                    {% else %}
                      <span class="data-missing">No Net Amount</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="currency-badge">{{ t.currency or 'TRY' }}</span>
                  </td>
                  <td>
                    {% if t.psp %}
                      <span class="badge bg-primary">{{ t.psp }}</span>
                    {% else %}
                      <span class="data-missing">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a href="{{ url_for('transactions.view_transaction', transaction_id=t.id) }}" class="btn-action btn-view" title="View Details" aria-label="View transaction details">
                        <i class="bi bi-eye"></i>
                        <span class="btn-text">View</span>
                      </a>
                      <a href="{{ url_for('transactions.edit_transaction', id=t.id) }}" class="btn-action btn-edit" title="Edit" aria-label="Edit transaction">
                        <i class="bi bi-pencil"></i>
                        <span class="btn-text">Edit</span>
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>



<!-- DataTables JavaScript -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>

<script>
// Wait for jQuery and DataTables to be available
let initAttempts = 0;
const maxAttempts = 50; // 5 seconds max

function initializeDataTable() {
    initAttempts++;
    
    if (initAttempts > maxAttempts) {
        console.error('DataTables initialization failed after', maxAttempts, 'attempts');
        // Fallback: Initialize basic table functionality without DataTables
        initializeBasicTable();
        return;
    }
    
    if (typeof $ === 'undefined') {
        // jQuery not loaded yet, wait a bit and try again
        setTimeout(initializeDataTable, 100);
        return;
    }
    
    // Check if DataTables is available
    if (typeof $.fn.DataTable === 'undefined') {
        // DataTables not loaded yet, wait a bit and try again
        setTimeout(initializeDataTable, 100);
        return;
    }
    
    // Check if DataTables plugins are available
    if (typeof $.fn.dataTable === 'undefined' || typeof $.fn.dataTable.ext === 'undefined') {
        // DataTables plugins not loaded yet, wait a bit and try again
        setTimeout(initializeDataTable, 100);
        return;
    }
    
    console.log('DataTables initialization successful after', initAttempts, 'attempts');
    
    $(document).ready(function() {
        // Initialize DataTable with clean configuration
        var table = $('#clientsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[0, 'asc']], // Sort by row number
        columnDefs: [
            { orderable: false, targets: [0, 11] }, // Disable sorting for # and Actions
            { className:"text-center", targets: [0, 11] },
            { className:"text-start", targets: [1] }
        ],
        // Prevent DataTables from interfering with links
        deferRender: true,
        processing: false,
        language: {
            {% if user_settings and user_settings.language == 'tr' %}
            search:"İşlem ara:",
            lengthMenu:"Sayfa başına _MENU_ işlem göster",
            info:"_TOTAL_ işlemden _START_ - _END_ arası gösteriliyor",
            paginate: {
                first:"İlk",
                last:"Son",
                next:"Sonraki",
                previous:"Önceki"
            },
            emptyTable:"Veri bulunamadı",
            zeroRecords:"Eşleşen kayıt bulunamadı"
            {% else %}
            search:"Search transactions:",
            lengthMenu:"Show _MENU_ transactions per page",
            info:"Showing _START_ to _END_ of _TOTAL_ transactions",
            paginate: {
                first:"First",
                last:"Last",
                next:"Next",
                previous:"Previous"
            },
            emptyTable:"No data available",
            zeroRecords:"No matching records found"
            {% endif %}
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        initComplete: function() {
            $('.dataTables_wrapper').addClass('mt-3');
            
            // Style date separators
            $('.date-separator-row').each(function() {
                $(this).addClass('no-hover');
            });
        },
        drawCallback: function() {
            // Re-apply date separator styling after each draw
            $('.date-separator-row').each(function() {
                $(this).addClass('no-hover');
            });
        }
    });
    
    // Filter functionality
    $('#clientFilter, #paymentMethodFilter, #categoryFilter, #pspFilter, #currencyFilter').on('change', function() {
        table.draw();
    });
    
    // Custom filtering function
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var client = $('#clientFilter').val();
        var payment = $('#paymentMethodFilter').val();
        var category = $('#categoryFilter').val();
        var psp = $('#pspFilter').val();
        var currency = $('#currencyFilter').val();
        
        if (client && data[1] !== client) return false;
        if (payment && data[3] !== payment) return false;
        if (category && data[5] !== category) return false;
        if (psp && data[10] !== psp) return false;
        if (currency && data[9] !== currency) return false;
        
        return true;
    });
    
    // Initialize filter functionality
    initializeFilterFunctions();
    });
}

// Start the initialization
initializeDataTable();

// Filter section toggle functionality
function toggleFilterSection() {
  const filterContent = document.getElementById('filterContent');
  const toggleIcon = document.getElementById('filterToggleIcon');
  const toggleText = document.getElementById('filterToggleText');
  
  if (filterContent.classList.contains('collapsed')) {
    filterContent.classList.remove('collapsed');
    toggleIcon.classList.remove('bi-chevron-down');
    toggleIcon.classList.add('bi-chevron-up');
    toggleText.textContent = '{{ _("Collapse") }}';
  } else {
    filterContent.classList.add('collapsed');
    toggleIcon.classList.remove('bi-chevron-up');
    toggleIcon.classList.add('bi-chevron-down');
    toggleText.textContent = 'Expand';
  }
}



// Edit transaction function
function editTransaction(transactionId) {
  window.location.href = `/transactions/edit/${transactionId}`;
}

// {{ _("Export") }} filtered data functionality
function exportFilteredData() {
  const clientFilter = document.getElementById('clientFilter').value;
  const paymentFilter = document.getElementById('paymentMethodFilter').value;
  const categoryFilter = document.getElementById('categoryFilter').value;
  const pspFilter = document.getElementById('pspFilter').value;
  
  // Show loading state
  const exportBtn = event.target;
  const originalText = exportBtn.innerHTML;
  exportBtn.innerHTML = '<i class="bi bi-download spin me-1"></i>{{ _("Export") }}ing...';
  exportBtn.disabled = true;
  
  // Build export URL with filters
  let exportUrl = '/api/transactions/export?';
  if (clientFilter) exportUrl += `client=${encodeURIComponent(clientFilter)}&`;
  if (paymentFilter) exportUrl += `payment_method=${encodeURIComponent(paymentFilter)}&`;
  if (categoryFilter) exportUrl += `category=${encodeURIComponent(categoryFilter)}&`;
  if (pspFilter) exportUrl += `psp=${encodeURIComponent(pspFilter)}&`;
  
  // Trigger download
  fetch(exportUrl)
    .then(response => response.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `transactions-${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('{{ _("Export") }} error:', error);
      alert('Error exporting data');
    })
    .finally(() => {
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
    });
}

// Edit transaction functionality
function editTransaction(transactionId) {
  window.location.href = `/transactions/edit/${transactionId}`;
}

// Initialize filter functions
function initializeFilterFunctions() {
  // Add real-time filter updates
  document.querySelectorAll('#clientFilter, #paymentMethodFilter, #categoryFilter, #pspFilter').forEach(select => {
    select.addEventListener('change', function() {
      // Update DataTable with new filters
      if (window.clientsTable) {
        window.clientsTable.draw();
      }
    });
  });
}

// Add spinning animation for loading states
const transactionsStyle = document.createElement('style');
transactionsStyle.textContent = `
  .spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .detail-item {
    margin-bottom: 1rem;
  }
  
  .detail-label {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
  }
  
  .detail-value {
    font-size: 1rem;
    color: #212529;
  }
`;
document.head.appendChild(transactionsStyle);

// Toggle filters
function toggleFilters() {
    if (typeof $ !== 'undefined') {
        $('#filterSection').slideToggle();
    }
}

// {{ _("Export") }} functionality
function exportTable() {
    if (typeof $ !== 'undefined') {
        var table = $('#clientsTable').DataTable();
        table.button('.buttons-excel').trigger();
    }
}

// Simple View Details function - Direct navigation
function viewTransactionDetails(transactionId) {
  window.location.href = `/transactions/view/${transactionId}`;
}

// Fallback function for basic table functionality without DataTables
function initializeBasicTable() {
    console.log('Initializing basic table functionality as fallback');
    
    // Add basic table styling
    const table = document.getElementById('clientsTable');
    if (table) {
        table.classList.add('table', 'table-striped', 'table-hover');
        
        // Add basic sorting functionality
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index > 0 && index < headers.length - 1) { // Skip first and last columns
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    sortTable(table, index);
                });
            }
        });
    }
}

// Basic table sorting function
function sortTable(table, columnIndex) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        return aValue.localeCompare(bValue);
    });
    
    // Clear and re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Function to open daily summary - DEFINITE SOLUTION
function openDailySummary(date) {
    console.log('Opening daily summary for date:', date);
    // Try the new guaranteed route first
    const url = `/summary/${date}`;
    console.log('Navigating to:', url);
    window.location.href = url;
}

// Fallback function if the link doesn't work
function forceOpenSummary(date) {
    console.log('Force opening summary for date:', date);
    // Direct navigation to the summary route
    window.location.href = `/summary/${date}`;
}

// Debug summary button clicks
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all summary buttons (fallback)
    document.querySelectorAll('.summary-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            console.log('Summary button clicked!');
            console.log('Button data-date:', this.getAttribute('data-date'));
            
            // Prevent any default interference
            e.stopPropagation();
            
            // Get the date and navigate
            const date = this.getAttribute('data-date');
            if (date) {
                openDailySummary(date);
            }
        });
    });
    
    // Also handle dynamically added summary buttons
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    const summaryBtns = node.querySelectorAll ? node.querySelectorAll('.summary-btn') : [];
                    summaryBtns.forEach(function(btn) {
                        btn.addEventListener('click', function(e) {
                            console.log('Dynamic summary button clicked!');
                            console.log('Button data-date:', this.getAttribute('data-date'));
                            e.stopPropagation();
                            const date = this.getAttribute('data-date');
                            if (date) {
                                openDailySummary(date);
                            }
                        });
                    });
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});

// Inline Summary - DEFINITE SOLUTION
function toggleInlineSummary(date, button) {
    console.log('Toggling inline summary for date:', date);
    
    // Find the date separator row
    const dateRow = button.closest('.date-separator-row');
    if (!dateRow) return;
    
    // Check if summary is already shown
    const existingSummary = dateRow.nextElementSibling;
    if (existingSummary && existingSummary.classList.contains('summary-row')) {
        // Hide summary
        existingSummary.remove();
        button.innerHTML = '<i class="bi bi-bar-chart me-1"></i> Summary';
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-light');
        return;
    }
    
    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Loading...';
    button.disabled = true;
    
    // Create summary row
    const summaryRow = document.createElement('tr');
    summaryRow.className = 'summary-row';
    summaryRow.innerHTML = `
        <td colspan="11" class="p-0">
            <div class="summary-content bg-light p-3">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading summary data...</p>
                </div>
            </div>
        </td>
    `;
    
    // Insert after date row
    dateRow.parentNode.insertBefore(summaryRow, dateRow.nextSibling);
    
    // Load summary data
    loadInlineSummaryData(date, summaryRow, button);
}

function loadInlineSummaryData(date, summaryRow, button) {
    fetch(`/api/summary/${date}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Create simple summary HTML
            const summaryHTML = createSimpleSummaryHTML(data);
            
            // Update summary row
            const summaryContent = summaryRow.querySelector('.summary-content');
            summaryContent.innerHTML = summaryHTML;
            
            // Update button
            button.innerHTML = '<i class="bi bi-bar-chart-fill me-1"></i> Hide Summary';
            button.classList.remove('btn-outline-light');
            button.classList.add('btn-primary');
            button.disabled = false;
        })
        .catch(error => {
            console.error('Error loading summary data:', error);
            const summaryContent = summaryRow.querySelector('.summary-content');
            summaryContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading summary data. Please try again.
                    <br><small>${error.message}</small>
                </div>
            `;
            
            // Reset button
            button.innerHTML = '<i class="bi bi-bar-chart me-1"></i> Summary';
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-light');
            button.disabled = false;
        });
}

function createSimpleSummaryHTML(data) {
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('tr-TR', {
            style: 'currency',
            currency: 'TRY',
            minimumFractionDigits: 2
        }).format(amount);
    };
    
    return `
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="border rounded p-2 bg-white">
                    <h6 class="text-primary mb-1">${data.transaction_count}</h6>
                    <small class="text-muted">Transactions</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-2 bg-white">
                    <h6 class="text-success mb-1">${data.unique_clients}</h6>
                    <small class="text-muted">Unique Clients</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-2 bg-white">
                    <h6 class="text-info mb-1">${formatCurrency(data.total_amount_tl)}</h6>
                    <small class="text-muted">Total Amount (TL)</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-2 bg-white">
                    <h6 class="text-warning mb-1">${formatCurrency(data.total_net_tl)}</h6>
                    <small class="text-muted">Net Amount (TL)</small>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="mb-2">PSP Breakdown:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>PSP</th>
                                <th>Count</th>
                                <th>Amount (TL)</th>
                                <th>Net (TL)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.psp_summary.map(psp => `
                                <tr>
                                    <td><strong>${psp.name}</strong></td>
                                    <td>${psp.count}</td>
                                    <td>${formatCurrency(psp.amount_tl)}</td>
                                    <td>${formatCurrency(psp.net_tl)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
</script> 