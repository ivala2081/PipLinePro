{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <h1 class="mb-4 fw-bold page-title"><i class="bi bi-sliders"></i> Manage Dropdown Options</h1>

  <div class="row mb-4">
    <div class="col-lg-8 col-xl-6 mx-auto">
      <div class="card shadow-sm border-0 filter-card">
        <div class="card-header bg-primary text-white fw-semibold">
          <i class="bi bi-plus-circle me-2"></i>Add New Option
        </div>
        <div class="card-body">
          <form method="POST" class="row g-3 align-items-center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add">
            <div class="col-md-4">
              <label for="field_name" class="form-label">Field</label>
              <select name="field_name" id="field_name" class="form-select pill-input" required onchange="toggleCommissionRate()">
                {% for field in fields %}
                  {% if field != 'category' %}
                    <option value="{{ field }}">{{ field.upper() }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="col-md-5">
              <label for="value" class="form-label">New Option Value</label>
              <input type="text" name="value" id="value" class="form-control pill-input" required placeholder="Enter value">
            </div>
            <div class="col-md-3" id="commission_rate_div" class="inline-style-1364" >
              <label for="commission_rate" class="form-label">Commission Rate
                <i class="bi bi-info-circle text-secondary" tabindex="0" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Set a decimal value, e.g. 0.110 for 11%."></i>
              </label>
              <input type="number" step="0.001" name="commission_rate" id="commission_rate" class="form-control pill-input" placeholder="e.g. 0.110">
            </div>
            <div class="col-12 text-end mt-2">
              <button type="submit" class="btn btn-success pill-btn px-4"><i class="bi bi-plus-lg"></i> Add Option</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-10 col-xl-8 mx-auto">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light fw-semibold">
          <i class="bi bi-list-ul me-2"></i>Existing Options
        </div>
        <div class="card-body">
          {% for field, opts in grouped_options.items() %}
            {% if field != 'category' %}
              <div class="mb-4">
                <h5 class="fw-bold text-primary mb-2">{{ field.upper() }}</h5>
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0 table-light">
                    <thead class="sticky-top">
                      <tr>
                        <th>Value</th>
                        {% if field == 'psp' %}
                          <th>Commission Rate</th>
                        {% endif %}
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for opt in opts %}
                        <tr>
                          <td>{{ opt.value }}</td>
                          {% if field == 'psp' %}
                            <td>
                              <span class="badge bg-info text-dark">{{ "{:.2f}".format(opt.commission_rate or 0) }}</span>
                            </td>
                          {% endif %}
                          <td class="text-end">
                            <a href="{{ url_for('settings.edit_option', id=opt.id) }}" class="btn btn-sm btn-outline-warning me-1 pill-btn" title="Edit" aria-label="Edit option"><i class="bi bi-pencil"></i></a>
                            <form action="{{ url_for('settings.delete_option', id=opt.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete this option?');">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <button type="submit" class="btn btn-sm btn-outline-danger pill-btn" title="Delete" aria-label="Delete option"><i class="bi bi-trash"></i></button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleCommissionRate() {
    var field = document.getElementById('field_name').value;
    var div = document.getElementById('commission_rate_div');
    if(field === 'psp') {
      div.style.display = 'block';
    } else {
      div.style.display = 'none';
    }
  }
  window.onload = function() {
    toggleCommissionRate();
    // Enable Bootstrap popover
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
  };

  function toggleTheme() {
    fetch("{{ url_for('settings.toggle_theme') }}?next=" + encodeURIComponent(window.location.pathname), {
      method: 'POST',
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
      .then(response => response.json())
      .then(() => window.location.reload());
  }
</script>

<style>
    .inline-style-1364 { display:none; }
.page-title {
  font-size: 1.5em;
  font-weight: 700;
  color: #2e3a8c;
  letter-spacing: 0.01em;
  display: flex;
  align-items: center;
  gap: 0.5em;
}
.filter-card.card {
  border-radius: 1.2em;
  background: linear-gradient(90deg, #f8fafc 0%, #e0e7ff 100%);
  box-shadow: 0 2px 12px rgba(44,62,80,0.07);
  border: none;
}
.pill-input {
  border-radius: 2em !important;
  border: 1.5px solid #6a82fb !important;
  font-size: 1em;
  padding: 0.5em 1.2em !important;
  background: #fff !important;
  color: #2e3a8c !important;
  box-shadow: 0 1px 4px rgba(44,62,80,0.04);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.pill-input:focus {
  border-color: #00b894 !important;
  box-shadow: 0 0 0 2px #00b89433 !important;
}
.pill-btn {
  border-radius: 2em !important;
  font-weight: 600;
  font-size: 1em;
  padding: 0.35em 1.3em !important;
  box-shadow: 0 1px 4px rgba(44,62,80,0.04);
  transition: background 0.15s, color 0.15s, box-shadow 0.15s;
}
.pill-btn:active, .pill-btn:focus {
  background: #6a82fb !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #6a82fb33 !important;
}
.table {
  border-radius: 1em;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(44,62,80,0.07);
}
.table thead.sticky-top {
  position: sticky;
  top: 0;
  z-index: 2;
  background: #e0e7ff;
}
.table th, .table td {
  white-space: nowrap;
  font-size: 0.92em;
  padding: 0.35em 0.5em;
  vertical-align: middle;
}
.table-striped > tbody > tr:hover, .table-hover > tbody > tr:hover {
  background-color: #e3e9f7;
  transition: background 0.15s;
}
.table-bordered {
  border: 1.5px solid #e0e7ff;
}
.table th, .table td, .badge, .currency-total {
  transition: background 0.15s, color 0.15s, box-shadow 0.15s;
}
@media (max-width: 1200px) {
  .table-responsive-lg { overflow-x: auto; }
}
@media (max-width: 992px) {
  .table-responsive-md { overflow-x: auto; }
}
@media (max-width: 768px) {
  .table-responsive-sm { overflow-x: auto; }
  .filter-card .row > div { margin-bottom: 0.7em; }
}
</style>

{% endblock %}