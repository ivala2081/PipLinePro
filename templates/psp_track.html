{% extends 'base.html' %}
{% block title %}{{ _('PSP Track') }} - Order PipLine{% endblock %}

{% block content %}
<div class="page-container">
  <!-- Enhanced Header -->
  <div class="page-header">
    <div class="d-flex">
      <div>
        <h1 class="h2 mb-1 text-dark fw-bold">
          <i class="bi bi-bank2 text-primary me-2"></i>
          {{ _('PSP Track') }}
        </h1>
        <p class="text-muted mb-0 small">
          {{ _('Payment Service Provider tracking and analytics') }}
        </p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="status-indicator">
          <span class="status-dot bg-success"></span>
          <span class="status-text small text-muted">{{ _('Live') }}</span>
        </div>
        <div class="text-end">
          <div class="small text-muted">{{ _('Updated') }}</div>
          <div class="small fw-semibold">{{ now.strftime('%H:%M') }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Streamlined Metrics -->
  <div class="metrics-row mb-4">
    <div class="row g-3">
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-primary bg-opacity-10">
            <i class="bi bi-shield-check text-primary"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ summary_data[0]['totals']['total_psp'] if summary_data and summary_data[0] and summary_data[0]['totals'] else 0 }}</div>
            <div class="metric-label">{{ _('Active PSPs') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-success bg-opacity-10">
            <i class="bi bi-currency-dollar text-success"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">₺{{ '{:,.0f}'.format(summary_data[0]['totals']['net']) if summary_data and summary_data[0] and summary_data[0]['totals'] else 0 }}</div>
            <div class="metric-label">{{ _('Net Position') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-warning bg-opacity-10">
            <i class="bi bi-arrow-repeat text-warning"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">₺{{ '{:,.0f}'.format(summary_data[0]['totals']['carry_over']) if summary_data and summary_data[0] and summary_data[0]['totals'] else 0 }}</div>
            <div class="metric-label">{{ _('Carry Over') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="metric-card">
          <div class="metric-icon bg-info bg-opacity-10">
            <i class="bi bi-percent text-info"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">₺{{ '{:,.0f}'.format(summary_data[0]['totals']['komisyon']) if summary_data and summary_data[0] and summary_data[0]['totals'] else 0 }}</div>
            <div class="metric-label">{{ _('Commission') }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Performance Summary -->
  {% if summary_data and summary_data[0] and summary_data[0].overall_metrics %}
  <div class="system-metrics mb-4">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-graph-up text-primary me-2"></i>
          {{ _('System Performance Summary') }}
        </h6>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-3">
            <div class="system-metric">
              <div class="metric-icon bg-primary bg-opacity-10">
                <i class="bi bi-currency-dollar text-primary"></i>
              </div>
              <div class="metric-content">
                <div class="metric-value">{{ '{:.1f}'.format(summary_data[0].overall_metrics.avg_roi) }}%</div>
                <div class="metric-label">{{ _('Average ROI') }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="system-metric">
              <div class="metric-icon bg-success bg-opacity-10">
                <i class="bi bi-check-circle text-success"></i>
              </div>
              <div class="metric-content">
                <div class="metric-value">{{ summary_data[0].overall_metrics.active_psps }}/{{ summary_data[0].overall_metrics.total_psps }}</div>
                <div class="metric-label">{{ _('Active PSPs') }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="system-metric">
              <div class="metric-icon bg-warning bg-opacity-10">
                <i class="bi bi-speedometer2 text-warning"></i>
              </div>
              <div class="metric-content">
                <div class="metric-value">{{ '{:.1f}'.format(summary_data[0].overall_metrics.avg_efficiency) }}%</div>
                <div class="metric-label">{{ _('Avg Efficiency') }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="system-metric">
              <div class="metric-icon bg-info bg-opacity-10">
                <i class="bi bi-graph-up text-info"></i>
              </div>
              <div class="metric-content">
                <div class="metric-value">{{ '{:.1f}'.format(summary_data[0].overall_metrics.avg_volatility) }}</div>
                <div class="metric-label">{{ _('Avg Volatility') }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Clean Tab Navigation -->
  <div class="tab-container">
    <ul class="nav nav-tabs border-0" id="pspTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'overview' %}active{% endif %} border-0"
                id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                type="button" role="tab">
          <i class="bi bi-grid-3x3-gap me-2"></i> {{ _('Overview') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'ledger' %}active{% endif %} border-0"
                id="ledger-tab" data-bs-toggle="tab" data-bs-target="#ledger"
                type="button" role="tab">
          <i class="bi bi-table me-2"></i> {{ _('Ledger') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'analytics' %}active{% endif %} border-0"
                id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics"
                type="button" role="tab">
          <i class="bi bi-bar-chart-line me-2"></i> {{ _('Analytics') }}
        </button>
      </li>
    </ul>
    
    <div class="tab-content bg-white rounded-bottom border-start border-end border-bottom" id="pspTabContent">
      <div class="tab-pane fade {% if active_tab == 'overview' %}show active{% endif %}"
           id="overview" role="tabpanel">
        {% include 'psp_overview_content.html' %}
      </div>
      <div class="tab-pane fade {% if active_tab == 'ledger' %}show active{% endif %}"
           id="ledger" role="tabpanel">
        {% include 'psp_ledger_content.html' %}
      </div>
      <div class="tab-pane fade {% if active_tab == 'analytics' %}show active{% endif %}"
           id="analytics" role="tabpanel">
        {% include 'psp_analytics_tab_content.html' %}
      </div>
    </div>
  </div>
</div>

{% endblock %}