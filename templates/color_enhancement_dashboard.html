{% extends "base.html" %}

{% block title %}Color Enhancement Dashboard{% endblock %}

{% block head %}

{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">üé® Color Enhancement Dashboard</h1>
        <p class="dashboard-subtitle">Automated color contrast analysis and improvement for professional business applications</p>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Analyzing color contrast issues...</p>
    </div>

    <!-- Alerts -->
    <div id="alerts"></div>

    <!-- Statistics Grid -->
    <div class="stats-grid" id="stats-grid" style="display: none;">
        <div class="stat-card" id="total-issues-card">
            <div class="stat-value" id="total-issues">-</div>
            <div class="stat-label">Total Issues</div>
        </div>
        <div class="stat-card critical" id="critical-issues-card">
            <div class="stat-value" id="critical-issues">-</div>
            <div class="stat-label">Critical Issues</div>
        </div>
        <div class="stat-card moderate" id="moderate-issues-card">
            <div class="stat-value" id="moderate-issues">-</div>
            <div class="stat-label">Moderate Issues</div>
        </div>
        <div class="stat-card good" id="pass-rate-card">
            <div class="stat-value" id="pass-rate">-</div>
            <div class="stat-label">Pass Rate</div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="actions-section">
        <h2>Actions</h2>
        <div class="actions-grid">
            <button class="action-btn primary" onclick="analyzeColors()">
                üîç Analyze Colors
            </button>
            <button class="action-btn secondary" onclick="getImprovements()">
                üí° View Improvements
            </button>
            <button class="action-btn success" onclick="applyImprovements()">
                ‚úÖ Apply Improvements
            </button>
            <button class="action-btn secondary" onclick="showContrastTester()">
                üéØ Test Contrast
            </button>
        </div>
    </div>

    <!-- Improvements Section -->
    <div class="improvements-section" id="improvements-section" style="display: none;">
        <h2>Top Improvements</h2>
        <div id="improvements-list"></div>
    </div>

    <!-- Contrast Tester -->
    <div class="contrast-tester" id="contrast-tester" style="display: none;">
        <h2>Contrast Ratio Tester</h2>
        <div class="tester-form">
            <div class="form-group">
                <label class="form-label">Foreground Color</label>
                <input type="color" id="fg-color" class="form-input" value="#6c757d">
            </div>
            <div class="form-group">
                <label class="form-label">Background Color</label>
                <input type="color" id="bg-color" class="form-input" value="#ffffff">
            </div>
            <div class="form-group">
                <label class="form-label">Element Type</label>
                <select id="element-type" class="form-input">
                    <option value="text">Normal Text</option>
                    <option value="large_text">Large Text</option>
                    <option value="heading">Heading</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <button class="action-btn primary" onclick="testContrast()">Test Contrast</button>
            </div>
        </div>
        <div id="contrast-results" class="results-display" style="display: none;"></div>
    </div>
</div>

<script>
// Global variables
let currentReport = null;

// Show/hide loading
function showLoading() {
    document.getElementById('loading').classList.add('show');
    document.getElementById('stats-grid').style.display = 'none';
    document.getElementById('improvements-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').classList.remove('show');
}

// Show alert
function showAlert(message, type = 'info') {
    const alerts = document.getElementById('alerts');
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.textContent = message;
    alerts.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Analyze colors
async function analyzeColors() {
    showLoading();
    
    try {
        const response = await fetch('/color-enhancement/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentReport = result.data;
            displayResults(result.data);
            showAlert('Color analysis completed successfully!', 'success');
        } else {
            showAlert('Error analyzing colors: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('Error analyzing colors: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Display results
function displayResults(data) {
    // Update statistics
    document.getElementById('total-issues').textContent = data.total_issues || 0;
    document.getElementById('critical-issues').textContent = data.critical_issues || 0;
    document.getElementById('moderate-issues').textContent = data.moderate_issues || 0;
    
    const passRate = data.summary?.pass_rate || 100;
    document.getElementById('pass-rate').textContent = passRate.toFixed(1) + '%';
    
    // Show stats grid
    document.getElementById('stats-grid').style.display = 'grid';
    
    // Display improvements if available
    if (data.improvements && data.improvements.length > 0) {
        displayImprovements(data.improvements);
    }
}

// Display improvements
function displayImprovements(improvements) {
    const container = document.getElementById('improvements-list');
    container.innerHTML = '';
    
    improvements.slice(0, 5).forEach((improvement, index) => {
        const item = document.createElement('div');
        item.className = 'improvement-item';
        
        const score = Math.round(improvement.improvement_score * 100);
        
        item.innerHTML = `
            <div class="improvement-header">
                <div class="improvement-title">${improvement.context} (${improvement.element_type})</div>
                <div class="improvement-score">+${score}%</div>
            </div>
            <div class="color-preview">
                <div class="color-box" style="background: ${improvement.original.foreground}">
                    ${improvement.original.foreground}
                </div>
                <div style="display: flex; align-items: center; font-weight: 600;">‚Üí</div>
                <div class="color-box" style="background: ${improvement.suggested.foreground}">
                    ${improvement.suggested.foreground}
                </div>
            </div>
            <div style="font-size: 0.875rem; color: #64748b;">
                Contrast: ${improvement.original.contrast_ratio.toFixed(2)} ‚Üí ${improvement.suggested.contrast_ratio.toFixed(2)}
            </div>
        `;
        
        container.appendChild(item);
    });
    
    document.getElementById('improvements-section').style.display = 'block';
}

// Get improvements
async function getImprovements() {
    showLoading();
    
    try {
        const response = await fetch('/color-enhancement/improvements');
        const result = await response.json();
        
        if (result.success) {
            if (result.css && result.css !== "/* No contrast issues found */") {
                // Create a download link for the CSS
                const blob = new Blob([result.css], { type: 'text/css' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'color_improvements.css';
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert('CSS improvements downloaded successfully!', 'success');
            } else {
                showAlert('No improvements needed - your colors are already well-optimized!', 'info');
            }
        } else {
            showAlert('Error getting improvements: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('Error getting improvements: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Apply improvements
async function applyImprovements() {
    if (!confirm('This will automatically apply color improvements. Continue?')) {
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/color-enhancement/apply-improvements', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Improvements applied successfully!', 'success');
        } else {
            showAlert('Error applying improvements: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('Error applying improvements: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Show contrast tester
function showContrastTester() {
    document.getElementById('contrast-tester').style.display = 'block';
}

// Test contrast
async function testContrast() {
    const fgColor = document.getElementById('fg-color').value;
    const bgColor = document.getElementById('bg-color').value;
    const elementType = document.getElementById('element-type').value;
    
    try {
        const response = await fetch('/color-enhancement/test-contrast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                foreground: fgColor,
                background: bgColor,
                element_type: elementType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayContrastResults(result.data);
        } else {
            showAlert('Error testing contrast: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('Error testing contrast: ' + error.message, 'error');
    }
}

// Display contrast results
function displayContrastResults(data) {
    const container = document.getElementById('contrast-results');
    
    container.innerHTML = `
        <h3>Contrast Analysis Results</h3>
        <div class="result-item">
            <span class="result-label">Contrast Ratio:</span>
            <span class="result-value">${data.contrast_ratio.toFixed(2)}</span>
        </div>
        <div class="result-item">
            <span class="result-label">WCAG AA Compliance:</span>
            <span class="result-value ${data.wcag_aa_passed ? 'passed' : 'failed'}">
                ${data.wcag_aa_passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
            </span>
        </div>
        <div class="result-item">
            <span class="result-label">WCAG AAA Compliance:</span>
            <span class="result-value ${data.wcag_aaa_passed ? 'passed' : 'failed'}">
                ${data.wcag_aaa_passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
            </span>
        </div>
        ${data.suggested_foreground ? `
        <div class="result-item">
            <span class="result-label">Suggested Foreground:</span>
            <span class="result-value">${data.suggested_foreground}</span>
        </div>
        <div class="result-item">
            <span class="result-label">Suggested Background:</span>
            <span class="result-value">${data.suggested_background}</span>
        </div>
        ` : ''}
    `;
    
    container.style.display = 'block';
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Auto-analyze on page load
    analyzeColors();
});
</script>
{% endblock %} 